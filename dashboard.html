<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Property Markets | Explorer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Instrument+Serif:ital@0;1&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a26;
            --bg-card: #16161f;
            --border: #2a2a3a;
            --text-primary: #f0f0f5;
            --text-secondary: #b8b8cc;
            --text-muted: #8a8aa0;
            --accent-hot: #ff4d4d;
            --accent-warm: #ff9f43;
            --accent-neutral: #feca57;
            --accent-cool: #48dbfb;
            --accent-cold: #0abde3;
            --accent-green: #10ac84;
            --gradient-hot: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            --gradient-cool: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Noise texture overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.03;
            pointer-events: none;
            z-index: 1000;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .logo h1 {
            font-family: 'Instrument Serif', serif;
            font-size: 2.5rem;
            font-weight: 400;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo span {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.2em;
        }

        .header-stats {
            display: flex;
            gap: 2.5rem;
        }

        .stat-item {
            text-align: right;
        }

        .stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent-warm);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Main layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
        }

        /* Map section */
        .map-section {
            background: var(--bg-secondary);
            border-radius: 1rem;
            border: 1px solid var(--border);
            overflow: hidden;
            position: relative;
        }

        .map-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .map-header h2 {
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-secondary);
        }

        .legend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-gradient {
            width: 120px;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, #0abde3 0%, #feca57 50%, #ff4d4d 100%);
        }

        .legend-labels {
            display: flex;
            justify-content: space-between;
            width: 120px;
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .map-container {
            height: 500px;
            position: relative;
        }

        #us-map {
            width: 100%;
            height: 100%;
        }

        .map-tooltip {
            position: absolute;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
            min-width: 200px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .map-tooltip.active {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }

        .tooltip-row span:first-child {
            color: var(--text-muted);
        }

        .tooltip-row span:last-child {
            font-family: 'Space Mono', monospace;
        }

        /* Controls */
        .controls-section {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-group label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
        }

        select, input[type="range"] {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            color: var(--text-primary);
            font-family: 'DM Sans', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: var(--accent-warm);
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 200px;
            height: 6px;
            padding: 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent-warm);
            cursor: pointer;
        }

        .alpha-display {
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            color: var(--accent-warm);
            min-width: 80px;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Market card */
        .market-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .market-card:hover {
            border-color: var(--accent-warm);
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(255, 159, 67, 0.1);
        }

        .market-card-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border-bottom: 1px solid var(--border);
        }

        .market-rank {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--accent-warm);
            text-transform: uppercase;
            letter-spacing: 0.2em;
            margin-bottom: 0.5rem;
        }

        .market-name {
            font-family: 'Instrument Serif', serif;
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 0.25rem;
        }

        .market-state {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .market-scores {
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .score-item {
            background: var(--bg-tertiary);
            border-radius: 0.75rem;
            padding: 1rem;
        }

        .score-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .score-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .score-value.investment { color: var(--accent-warm); }
        .score-value.appreciation { color: var(--accent-hot); }
        .score-value.cashflow { color: var(--accent-green); }
        .score-value.migration { color: var(--accent-cool); }

        .score-bar {
            height: 4px;
            background: var(--bg-primary);
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .score-bar-fill.investment { background: var(--gradient-hot); }
        .score-bar-fill.appreciation { background: var(--accent-hot); }
        .score-bar-fill.cashflow { background: var(--accent-green); }
        .score-bar-fill.migration { background: var(--accent-cool); }

        /* Market details */
        .market-details {
            padding: 0 1.5rem 1.5rem;
        }

        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .detail-item span:first-child {
            color: var(--text-muted);
        }

        .detail-item span:last-child {
            font-family: 'Space Mono', monospace;
            color: var(--text-primary);
        }

        /* Market Summary */
        .market-summary {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid var(--border);
            background: linear-gradient(180deg, var(--bg-tertiary) 0%, transparent 100%);
        }

        .market-summary-header {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .market-summary-header::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--accent-warm);
            border-radius: 50%;
            flex-shrink: 0;
        }

        .breakdown-link {
            margin-left: auto;
            font-size: 0.6rem;
            color: var(--accent-cool);
            text-decoration: none;
            text-transform: none;
            letter-spacing: 0.05em;
            transition: all 0.2s ease;
            opacity: 0.8;
        }

        .breakdown-link:hover {
            opacity: 1;
            color: var(--accent-warm);
        }

        .market-summary-content {
            font-size: 0.82rem;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .market-summary-content p {
            margin: 0 0 0.6rem 0;
            position: relative;
            padding-left: 0;
        }

        .market-summary-content p:last-child {
            margin-bottom: 0;
        }

        .market-summary-content .sentence-position {
            color: var(--accent-warm);
            font-weight: 600;
        }

        .market-summary-content .sentence-strength {
            color: var(--accent-green);
        }

        .market-summary-content .sentence-migration {
            color: var(--accent-cool);
        }

        .market-summary-content .sentence-risk {
            color: var(--accent-hot);
        }

        .market-summary-content .sentence-fit {
            color: var(--text-primary);
            font-style: italic;
        }

        .market-summary-content strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .market-summary-content .highlight-positive {
            color: var(--accent-green);
        }

        .market-summary-content .highlight-negative {
            color: var(--accent-hot);
        }

        .market-summary-content .highlight-neutral {
            color: var(--accent-cool);
        }

        /* Rankings list */
        .rankings-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 1rem;
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
            max-height: 400px;
        }

        .rankings-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rankings-header h3 {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-secondary);
        }

        .rankings-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ranking-item:hover {
            background: var(--bg-tertiary);
        }

        .ranking-item.active {
            background: var(--bg-tertiary);
            border: 1px solid var(--accent-warm);
        }

        .ranking-position {
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-muted);
            width: 24px;
        }

        .ranking-info {
            flex: 1;
            min-width: 0;
        }

        .ranking-name {
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ranking-state {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .ranking-score {
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--accent-warm);
        }

        /* Comparison section */
        .comparison-section,
        .comparison-section-inline {
            background: var(--bg-tertiary);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-top: 1rem;
        }

        .comparison-section {
            grid-column: 1 / -1;
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .comparison-header h3 {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-secondary);
        }

        .chart-container {
            height: 250px;
            position: relative;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .sidebar {
                flex-direction: row;
            }

            .market-card, .rankings-card {
                flex: 1;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            header {
                flex-direction: column;
                gap: 1.5rem;
            }

            .header-stats {
                align-self: flex-start;
            }

            .sidebar {
                flex-direction: column;
            }

            .market-scores {
                grid-template-columns: 1fr;
            }
        }

        /* Alpha Explanation Panel */
        .alpha-panel,
        .alpha-panel-inline {
            background: var(--bg-tertiary);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-top: 1rem;
        }

        .alpha-panel h3,
        .alpha-panel-inline h3 {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .alpha-explanation {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .strategy-card {
            background: var(--bg-tertiary);
            border-radius: 0.75rem;
            padding: 1rem;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .strategy-card.active {
            border-color: var(--accent-warm);
        }

        .strategy-card h4 {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .strategy-card h4 .icon {
            font-size: 1.2rem;
        }

        .strategy-card p {
            font-size: 0.75rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .strategy-card .range {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--accent-cool);
            margin-top: 0.5rem;
        }

        .formula-display {
            background: var(--bg-primary);
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            text-align: center;
            border: 1px solid var(--border);
        }

        .formula-display .alpha-val {
            color: var(--accent-warm);
            font-weight: 700;
        }

        .formula-display .one-minus {
            color: var(--accent-green);
        }

        /* Score Breakdown Panel */
        .breakdown-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .breakdown-header h3 {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-secondary);
        }

        .breakdown-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .breakdown-tab {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }

        .breakdown-tab:hover {
            border-color: var(--text-muted);
        }

        .breakdown-tab.active {
            background: var(--accent-warm);
            border-color: var(--accent-warm);
            color: var(--bg-primary);
        }

        .breakdown-content {
            display: none;
        }

        .breakdown-content.active {
            display: block;
        }

        .component-row {
            display: grid;
            grid-template-columns: 140px 1fr 60px 50px 70px;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .component-row:last-child {
            border-bottom: none;
        }

        .component-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .component-bar-container {
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .component-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .component-bar.appreciation { background: var(--accent-hot); }
        .component-bar.cashflow { background: var(--accent-green); }
        .component-bar.migration { background: var(--accent-cool); }

        .component-raw {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-align: right;
        }

        .component-weight {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--accent-warm);
            text-align: center;
        }

        .component-contribution {
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-primary);
            text-align: right;
            font-weight: 600;
        }

        .breakdown-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--border);
        }

        .breakdown-total-label {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .breakdown-total-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .breakdown-total-value.appreciation { color: var(--accent-hot); }
        .breakdown-total-value.cashflow { color: var(--accent-green); }

        .raw-value-tooltip {
            font-size: 0.65rem;
            color: var(--text-muted);
            display: block;
        }

        .component-header {
            display: grid;
            grid-template-columns: 140px 1fr 60px 50px 70px;
            gap: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 0.5rem;
        }

        .component-header span {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
        }

        .component-header span:nth-child(3),
        .component-header span:nth-child(4),
        .component-header span:nth-child(5) {
            text-align: right;
        }

        .component-header span:nth-child(4) {
            text-align: center;
        }

        /* Interpretation text with toggle */
        .component-wrapper {
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .component-wrapper:last-child {
            border-bottom: none;
        }

        .interpretation-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.3rem 0.6rem;
            margin-top: 0.4rem;
            font-size: 0.68rem;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .interpretation-toggle:hover {
            color: var(--text-secondary);
            border-color: var(--text-muted);
        }

        .interpretation-toggle .toggle-icon {
            font-size: 0.5rem;
            transition: transform 0.2s;
        }

        .interpretation-toggle.expanded {
            color: var(--text-secondary);
            border-color: var(--accent-warm);
        }

        .interpretation-toggle.expanded .toggle-icon {
            transform: rotate(90deg);
        }

        .component-interpretation {
            padding: 0.75rem 1rem;
            background: var(--bg-primary);
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            border-left: 3px solid var(--border);
            display: none;
            animation: slideDown 0.2s ease;
        }

        .component-interpretation.visible {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .component-interpretation.appreciation {
            border-left-color: var(--accent-hot);
        }

        .component-interpretation.cashflow {
            border-left-color: var(--accent-green);
        }

        .interpretation-meaning {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 0.5rem;
        }

        .interpretation-comparison {
            font-size: 0.75rem;
            color: var(--text-muted);
            line-height: 1.4;
            font-style: italic;
        }

        .interpretation-comparison .highlight {
            color: var(--accent-warm);
            font-weight: 600;
            font-style: normal;
        }

        .interpretation-comparison .positive {
            color: var(--accent-green);
        }

        .interpretation-comparison .negative {
            color: var(--accent-hot);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <h1>Investment Markets</h1>
                <span>Real Estate Analytics Dashboard</span>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <div class="stat-value" id="total-markets">79</div>
                    <div class="stat-label">Markets Analyzed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avg-score">50.2</div>
                    <div class="stat-label">Avg Investment Score</div>
                </div>
            </div>
        </header>

        <div class="main-grid">
            <div class="map-section">
                <div class="map-header">
                    <h2>Market Heat Map</h2>
                    <div class="legend">
                        <div>
                            <div class="legend-gradient"></div>
                            <div class="legend-labels">
                                <span>Low</span>
                                <span>High</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="map-container">
                    <svg id="us-map"></svg>
                    <div class="map-tooltip" id="tooltip"></div>
                </div>
                <div class="controls-section">
                    <div class="control-group">
                        <label>Color by</label>
                        <select id="color-metric">
                            <option value="investmentScore">Investment Score</option>
                            <option value="appreciationScore">Appreciation Score</option>
                            <option value="cashFlowScore">Cash Flow Score</option>
                            <option value="migrationScore">Migration Score</option>
                            <option value="netMigration">Net Migration</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Sort Rankings by</label>
                        <select id="sort-metric">
                            <option value="investmentScore">Investment Score</option>
                            <option value="appreciationScore">Appreciation Score</option>
                            <option value="cashFlowScore">Cash Flow Score</option>
                            <option value="migrationScore">Migration Score</option>
                            <option value="priceToIncome">Price-to-Income</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Investment Style (Î±)</label>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <input type="range" id="alpha-slider" min="0" max="100" value="70">
                            <span class="alpha-display" id="alpha-value">Î± = 0.70</span>
                        </div>
                    </div>
                </div>
                <!-- Alpha Explanation Panel -->
                <div class="alpha-panel-inline">
                    <h3>Understanding the Investment Style Parameter (Î±)</h3>
                    <div class="alpha-explanation">
                        <div class="strategy-card" id="growth-strategy">
                            <h4><span class="icon">ðŸ“ˆ</span> Growth-Focused (Î± â†’ 1.0)</h4>
                            <p>Prioritizes <strong>price appreciation</strong>. Best for investors with longer time horizons who can wait for property values to increase. Higher risk, higher potential reward. Focus on markets with strong migration, limited supply, and price momentum.</p>
                            <div class="range">Recommended: Î± = 0.7 â€“ 1.0</div>
                        </div>
                        <div class="strategy-card" id="income-strategy">
                            <h4><span class="icon">ðŸ’°</span> Income-Focused (Î± â†’ 0.0)</h4>
                            <p>Prioritizes <strong>rental cash flow</strong>. Best for investors seeking immediate income and lower risk. Focus on markets with favorable price-to-rent ratios, strong rent growth, and stable employment.</p>
                            <div class="range">Recommended: Î± = 0.0 â€“ 0.3</div>
                        </div>
                    </div>
                    <div class="formula-display">
                        Investment Score = <span class="alpha-val" id="formula-alpha">0.70</span> Ã— Appreciation Score + <span class="one-minus" id="formula-one-minus">0.30</span> Ã— Cash Flow Score
                    </div>
                </div>
                <!-- Scatter Chart -->
                <div class="comparison-section-inline">
                    <div class="comparison-header">
                        <h3>Appreciation vs Cash Flow Analysis</h3>
                    </div>
                    <div class="chart-container" id="scatter-chart"></div>
                </div>
            </div>

            <div class="sidebar">
                <div class="market-card" id="selected-market">
                    <div class="market-card-header">
                        <div class="market-rank">Rank #1</div>
                        <div class="market-name">Pittsburgh</div>
                        <div class="market-state">Pennsylvania</div>
                    </div>
                    <div class="market-scores">
                        <div class="score-item">
                            <div class="score-label">Investment Score</div>
                            <div class="score-value investment" id="card-investment">63.9</div>
                            <div class="score-bar"><div class="score-bar-fill investment" style="width: 63.9%"></div></div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Appreciation</div>
                            <div class="score-value appreciation" id="card-appreciation">58.8</div>
                            <div class="score-bar"><div class="score-bar-fill appreciation" style="width: 58.8%"></div></div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Cash Flow</div>
                            <div class="score-value cashflow" id="card-cashflow">69.0</div>
                            <div class="score-bar"><div class="score-bar-fill cashflow" style="width: 69%"></div></div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Migration</div>
                            <div class="score-value migration" id="card-migration">68.3</div>
                            <div class="score-bar"><div class="score-bar-fill migration" style="width: 68.3%"></div></div>
                        </div>
                    </div>
                    <div class="market-details">
                        <div class="details-grid">
                            <div class="detail-item">
                                <span>Home Value</span>
                                <span id="card-home-value">$221K</span>
                            </div>
                            <div class="detail-item">
                                <span>Price/Income</span>
                                <span id="card-pti">2.77x</span>
                            </div>
                            <div class="detail-item">
                                <span>Net Migration</span>
                                <span id="card-net-migration">-4,270</span>
                            </div>
                            <div class="detail-item">
                                <span>AGI Ratio</span>
                                <span id="card-agi-ratio">0.92</span>
                            </div>
                        </div>
                    </div>
                    <div class="market-summary">
                        <div class="market-summary-header">
                            Investment Analysis
                            <a href="#score-breakdown" class="breakdown-link" id="breakdown-link">View Score Breakdown â†’</a>
                        </div>
                        <div class="market-summary-content" id="market-summary-text">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <div class="rankings-card">
                    <div class="rankings-header">
                        <h3>Top Markets</h3>
                    </div>
                    <div class="rankings-list" id="rankings-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Score Breakdown Panel -->
            <div class="breakdown-panel" id="score-breakdown" style="grid-column: 1 / -1;">
                <div class="breakdown-header">
                    <h3>Score Breakdown for <span id="breakdown-market-name">Pittsburgh</span></h3>
                    <div class="breakdown-tabs">
                        <div class="breakdown-tab active" data-tab="appreciation">Appreciation</div>
                        <div class="breakdown-tab" data-tab="cashflow">Cash Flow</div>
                    </div>
                </div>

                <!-- Appreciation Score Breakdown -->
                <div class="breakdown-content active" id="appreciation-breakdown">
                    <div class="component-header">
                        <span>Component</span>
                        <span>Normalized Score (0-100)</span>
                        <span>Raw Value</span>
                        <span>Weight</span>
                        <span>Contribution</span>
                    </div>
                    <div id="appreciation-components">
                        <!-- Populated by JS -->
                    </div>
                    <div class="breakdown-total">
                        <span class="breakdown-total-label">Total Appreciation Score</span>
                        <span class="breakdown-total-value appreciation" id="appreciation-total">58.8</span>
                    </div>
                </div>

                <!-- Cash Flow Score Breakdown -->
                <div class="breakdown-content" id="cashflow-breakdown">
                    <div class="component-header">
                        <span>Component</span>
                        <span>Normalized Score (0-100)</span>
                        <span>Raw Value</span>
                        <span>Weight</span>
                        <span>Contribution</span>
                    </div>
                    <div id="cashflow-components">
                        <!-- Populated by JS -->
                    </div>
                    <div class="breakdown-total">
                        <span class="breakdown-total-label">Total Cash Flow Score</span>
                        <span class="breakdown-total-value cashflow" id="cashflow-total">69.0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Metro coordinates (approximate lat/lng for major metros)
        const metroCoordinates = {
            "Pittsburgh, PA": [-79.9959, 40.4406],
            "Rochester, NY": [-77.6109, 43.1566],
            "Lansing-East Lansing, MI": [-84.5555, 42.7325],
            "Bloomington, IL": [-88.9937, 40.4842],
            "Hartford-West Hartford-East Hartford, CT": [-72.6851, 41.7658],
            "Manchester-Nashua, NH": [-71.4548, 42.9956],
            "New Haven, CT": [-72.9279, 41.3083],
            "Chicago-Naperville-Elgin, IL-IN": [-87.6298, 41.8781],
            "Atlantic City-Hammonton, NJ": [-74.4229, 39.3643],
            "Albany-Schenectady-Troy, NY": [-73.7562, 42.6526],
            "Akron, OH": [-81.5190, 41.0814],
            "Omaha, NE-IA": [-95.9345, 41.2565],
            "Bridgeport-Stamford-Danbury, CT": [-73.2048, 41.1865],
            "Trenton-Princeton, NJ": [-74.7429, 40.2206],
            "Detroit-Warren-Dearborn, MI": [-83.0458, 42.3314],
            "Harrisburg-Carlisle, PA": [-76.8867, 40.2737],
            "Worcester, MA": [-71.8023, 42.2626],
            "Buffalo-Cheektowaga, NY": [-78.8784, 42.8864],
            "Virginia Beach-Chesapeake-Norfolk, VA-NC": [-76.2859, 36.8529],
            "Philadelphia-Camden-Wilmington, PA-NJ-DE-MD": [-75.1652, 39.9526],
            "San Jose-Sunnyvale-Santa Clara, CA": [-121.8863, 37.3382],
            "Milwaukee-Waukesha, WI": [-87.9065, 43.0389],
            "Ann Arbor, MI": [-83.7430, 42.2808],
            "Providence-Warwick, RI-MA": [-71.4128, 41.8240],
            "Greensboro-High Point, NC": [-79.7920, 36.0726],
            "Columbia, SC": [-81.0348, 34.0007],
            "St. Louis, MO-IL": [-90.1994, 38.6270],
            "Baltimore-Columbia-Towson, MD": [-76.6122, 39.2904],
            "Oklahoma City, OK": [-97.5164, 35.4676],
            "Allentown-Bethlehem-Easton, PA-NJ": [-75.4714, 40.6084],
            "Minneapolis-St. Paul-Bloomington, MN-WI": [-93.2650, 44.9778],
            "Indianapolis-Carmel-Greenwood, IN": [-86.1581, 39.7684],
            "Kansas City, MO-KS": [-94.5786, 39.0997],
            "San Francisco-Oakland-Fremont, CA": [-122.4194, 37.7749],
            "Des Moines-West Des Moines, IA": [-93.6091, 41.5868],
            "Lafayette-West Lafayette, IN": [-86.8786, 40.4167],
            "Cincinnati, OH-KY-IN": [-84.5120, 39.1031],
            "Birmingham, AL": [-86.8025, 33.5207],
            "Madison, WI": [-89.4012, 43.0731],
            "Richmond, VA": [-77.4360, 37.5407],
            "Gainesville, FL": [-82.3248, 29.6516],
            "Greenville-Anderson-Greer, SC": [-82.3940, 34.8526],
            "Boston-Cambridge-Newton, MA-NH": [-71.0589, 42.3601],
            "Fresno, CA": [-119.7871, 36.7378],
            "Fayetteville-Springdale-Rogers, AR": [-94.1574, 36.0626],
            "Houston-Pasadena-The Woodlands, TX": [-95.3698, 29.7604],
            "Memphis, TN-MS-AR": [-90.0490, 35.1495],
            "Miami-Fort Lauderdale-West Palm Beach, FL": [-80.1918, 25.7617],
            "New York-Newark-Jersey City, NY-NJ": [-74.0060, 40.7128],
            "Charlotte-Concord-Gastonia, NC-SC": [-80.8431, 35.2271],
            "Dallas-Fort Worth-Arlington, TX": [-96.7970, 32.7767],
            "Atlanta-Sandy Springs-Roswell, GA": [-84.3880, 33.7490],
            "Stockton-Lodi, CA": [-121.2908, 37.9577],
            "Bakersfield-Delano, CA": [-119.0187, 35.3733],
            "Columbus, OH": [-82.9988, 39.9612],
            "Seattle-Tacoma-Bellevue, WA": [-122.3321, 47.6062],
            "Orlando-Kissimmee-Sanford, FL": [-81.3792, 28.5383],
            "Tampa-St. Petersburg-Clearwater, FL": [-82.4572, 27.9506],
            "Yuba City, CA": [-121.6169, 39.1404],
            "Raleigh-Cary, NC": [-78.6382, 35.7796],
            "Durham-Chapel Hill, NC": [-78.8986, 35.9940],
            "Modesto, CA": [-120.9969, 37.6390],
            "Salt Lake City-Murray, UT": [-111.8910, 40.7608],
            "Washington-Arlington-Alexandria, DC-VA-MD-WV": [-77.0369, 38.9072],
            "Oxnard-Thousand Oaks-Ventura, CA": [-119.1791, 34.2000],
            "Sacramento-Roseville-Folsom, CA": [-121.4944, 38.5816],
            "Nashville-Davidson--Murfreesboro--Franklin, TN": [-86.7816, 36.1627],
            "Riverside-San Bernardino-Ontario, CA": [-117.3962, 33.9534],
            "Jacksonville, FL": [-81.6557, 30.3322],
            "San Diego-Chula Vista-Carlsbad, CA": [-117.1611, 32.7157],
            "Merced, CA": [-120.4830, 37.3022],
            "Phoenix-Mesa-Chandler, AZ": [-112.0740, 33.4484],
            "Portland-Vancouver-Hillsboro, OR-WA": [-122.6765, 45.5051],
            "Las Vegas-Henderson-North Las Vegas, NV": [-115.1398, 36.1699],
            "Denver-Aurora-Centennial, CO": [-104.9903, 39.7392],
            "San Antonio-New Braunfels, TX": [-98.4936, 29.4241],
            "Los Angeles-Long Beach-Anaheim, CA": [-118.2437, 34.0522],
            "Austin-Round Rock-San Marcos, TX": [-97.7431, 30.2672],
            "Louisville/Jefferson County, KY-IN": [-85.7585, 38.2527]
        };

        // Parse and load data
        const csvData = `Rank,Metropolitan Area,State,Investment Score (v2),Appreciation Score,Cash Flow Score,Boom Score (Legacy v1),Median Home Value,Price-to-Income Ratio,1-Year Price Change (%),3-Year Price CAGR (%),Indian Pop (2018),Indian Pop (2023),Indian Pop CAGR (%),Tech Wage CAGR (%),Latest Tech Wages ($),Tech Employment,Median Income,Supply Constraint (0-100),Price Momentum (0-100),Affordability Gap (0-100),Price-to-Rent (0-100),Rent Growth (0-100),Unemployment Rate (%),Zillow Home Value,Zillow Monthly Rent,Price-to-Rent Ratio,1-Year Rent Change (%),Net Migration (Households),Avg AGI Inflow ($K),AGI Ratio (In/Out),Migration Score (0-100)
1,"Pittsburgh, PA Metro Area",PA,63.902234075726895,58.828626270901644,68.97584188055214,80.08488842637378,204500,2.765681209596711,1.2529012126369983,2.760609936794789,446,22602,119.26151086484626,0.4544658899928722,323750290,10976,73942,1.2493492972410203,66.25603823725413,88.13265469973352,93.44060741930443,81.12195505133823,4.1,221008.5721627516,1471.8437845809906,12.513135705366826,3.7539354912466347,-4270.0,96.23524055243588,0.9179889847816731,68.34640316731486
2,"Rochester, NY Metro Area",NY,63.34033793361778,64.59814984017305,62.082526027062514,67.02762901482737,190100,2.553803165050109,2.6692079761779417,6.740922422427653,470,6251,67.79164360036872,-10.56490559534743,125710806,4784,74438,0.0,87.01353462326526,98.78242548078462,71.7712625254428,87.68934920690474,4.2,264771.0348680236,1490.4941783362835,14.803313710555482,4.277995477859681,-3473.0,74.93845260560313,0.9492373776025803,68.81983178235235
3,"Lansing-East Lansing, MI Metro Area",MI,62.207322699088294,62.92843567776231,61.48620972041428,67.4292610860452,205400,2.897610247439551,2.876198699338071,4.918361035220276,395,5319,68.20797361201134,2.2977914954505962,47090046,1965,70886,1.3274336283185841,82.65818278654912,82.28822483330725,69.19382958760694,98.69341089571869,5.1,236852.71586853833,1304.3059144580973,15.132743096222692,5.156089328286041,-865.0,63.587951122477975,0.9397128564622201,70.7070148427078
4,"Bloomington, IL Metro Area",IL,61.375983262056586,67.2676307742402,55.48433574987297,69.84061216786247,198300,2.531629409286471,3.9603987118403197,5.316576607966672,223,5285,88.34236768881931,0.0,21344427,786,78329,0.7114350164844698,90.40790366802514,100.0,67.78700751208203,70.21611452357016,4.4,249990.02279673028,1359.9290909090907,15.318814810999688,2.883679419263826,-635.0,80.39644970414201,0.8804313826775857,70.89983043270345
5,"Hartford-West Hartford-East Hartford, CT Metro Area",CT,61.242277044470235,65.97579682035,56.50875726859047,68.02815643925643,309300,3.332148282214537,4.386699935792373,7.6027811608521345,314,30037,148.9690609709189,0.2117787178268271,360559291,11046,92823,10.341835849384001,100.0,66.31077907763155,56.6317091283348,72.58705625850837,3.8,377749.6322446456,1854.576864420982,16.973756453181704,3.0728740472151403,-3672.0,84.68534449352863,0.8452654168760694,68.96638360117213
6,"Manchester-Nashua, NH Metro Area",NH,61.01445895696469,61.63260173571696,60.39631617821241,54.11404305515293,385500,3.8382651638854592,2.403358041579587,5.711020120017984,122,6006,117.99428061852666,-0.2622950496679932,158286549,4251,100436,16.952975880617736,82.24818029805189,52.26210381210738,39.3063263431958,91.54978458876974,3.0,503488.3739759787,2057.143355274862,20.39593613659081,4.586047601216086,970.0,100.5935848149928,0.9565698708084507,72.02958499293366
7,"New Haven, CT Metro Area",CT,60.0548681143225,60.5897302141929,59.52000601445211,50.83986236079872,328300,3.8056708320775274,3.5792502365855343,6.7687469943978895,184,5169,94.85777617455841,-27.842835718023252,63103729,1810,86266,11.990282838799237,92.57666893695705,53.054276254704455,58.944903516369976,83.97828486676453,3.8,386135.915232952,1938.218401213541,16.601840595431515,3.9818627527109083,-1224.0,85.68280376380744,0.9442905040124004,70.446440221137
8,"Chicago-Naperville-Elgin, IL-IN Metro Area",IL,59.85274347836472,49.20445476639108,70.50103219033836,45.442446916649274,301900,3.39786156443444,3.405287294738539,4.95490829817864,6602,233793,104.09445083729443,-100.0,0,0,88850,9.699809127190699,85.95513198247647,64.25030571923128,82.18451575534105,93.95413489674687,4.4,334511.78673974896,2048.71152452408,13.606592189590025,4.777908141388411,-34038.0,94.47328226528263,0.6778711040462955,53.79388029149712
9,"Atlantic City-Hammonton, NJ Metro Area",NJ,59.845446889375665,62.35277816683101,57.33811561192033,67.73203896182568,302600,3.7543424317617866,3.1626149441341687,6.828680692929434,91,6405,134.150747389574,3.1647257494435976,26945554,903,80600,9.760541384695472,90.25309898619932,54.329647056376885,73.5303969458349,73.15135293786955,5.2,369166.33331587375,2109.051184926185,14.586588191662525,3.117903369839418,-980.0,107.90613359821207,1.0030186219994948,70.57777097729252
10,"Albany-Schenectady-Troy, NY Metro Area",NY,58.742978228138114,62.42140614951471,55.064550306761525,65.30975662376581,268400,3.118319546426248,3.500139218420231,4.993240104128116,169,14479,143.54003981414158,-5.948065571641569,189727983,6270,86072,6.793336803748049,86.64385823407483,73.61653192553571,47.74702033537672,88.45414816717617,4.2,352656.5113372632,1582.4069264069265,18.57173532358596,4.339024330915775,-3101.0,129.09057273938137,1.1326526241415011,68.65598158301071
11,"Akron, OH Metro Area",OH,58.64313796491269,63.739609066312,53.54666686351338,71.45986972781003,199000,2.7905541844289883,3.3636111740526204,5.261289224231769,120,5654,116.0901204730195,-6.150145790250383,80690614,3312,71312,0.7721672739892417,86.64587510637963,86.98851515608328,67.60057889602729,71.978535312008,4.8,229491.04974917352,1246.3818330362449,15.343816508603044,3.024315749734786,-662.0,157.37510271158587,1.7745947150566357,70.43202707198111
12,"Omaha, NE-IA Metro Area",NE,58.259671113422186,58.56047333433018,57.95886889251418,55.61772526606338,248100,2.9883285354660756,1.4306656917522147,3.275347549056762,582,6784,63.42277129652236,-11.904001897485273,190429514,6344,83023,5.032101336109665,68.90795195823617,78.56884630701943,52.62204017072213,77.45636289559901,3.0,295611.26474932063,1394.95844063748,17.65950249470214,3.4614313213183907,-664.0,69.63647892577397,0.8363137411290559,70.9026884296589
13,"Bridgeport-Stamford-Danbury, CT Metro Area",CT,57.99271498571061,64.47159656374012,51.513833407681105,52.95712756996964,530800,4.753886938453823,3.892781342182471,6.126912673348084,522,17251,101.2930379836697,9.553680264041464,234225828,4955,111656,29.559257331251082,92.4913008731171,34.44750143598788,43.58920134116558,60.580530317419445,3.8,646945.9589501537,2775.020532469263,19.427662828092352,2.1147863072516335,-682.0,248.3373652694611,1.0904420938816344,70.7595690131031
14,"Trenton-Princeton, NJ Metro Area",NJ,57.639025068628634,59.21688770494566,56.061162432311605,78.74586316243165,351000,3.643611223568248,0.44545755018310756,6.050004006722998,108,26804,201.2695028263458,8.758749138353018,150887871,4892,96333,13.959743189311121,71.50520456011404,57.20339034281311,75.8358277265449,55.17232586116242,5.2,431761.3425808419,2513.984571805006,14.311985954593032,1.6832264696949988,-1820.0,121.49988143229784,0.9776450039876231,69.97271470040974
15,"Detroit-Warren-Dearborn, MI Metro Area",MI,57.240315457290905,59.780934259847534,54.69969665473428,75.6493153418121,237100,3.156157235467167,3.0065546481368863,4.286912581295121,1280,92031,135.14991943138415,-6.342246489969938,719638275,23691,75123,4.077737289606108,81.50218662773545,72.25166848786124,75.0080390038107,65.45168133186144,5.1,256080.86150006903,1480.9840215431348,14.40938692197151,2.5034907575936107,-7840.0,85.35055306187881,0.7695877926922915,66.74041102340227
16,"Harrisburg-Carlisle, PA Metro Area",PA,56.461164851838205,63.01624436011806,49.906085343558345,69.84334651448081,239100,3.0158549967835926,3.4251298507506913,4.661577668258277,100,11443,158.0524457731775,-5.3847295992295985,82890018,3021,79281,4.251258025334027,85.17307803191144,77.48453139715627,50.286461785723006,71.48135102099538,4.1,299596.08798164217,1380.492792792793,18.085093088120313,2.9846418110735202,240.0,69.14120991944401,0.798251458307192,71.47016364786779
17,"Worcester, MA Metro Area",MA,56.30789927865044,59.1662414599137,53.44955709738717,59.255453212914986,390700,4.175885251333355,1.412715277650485,5.545999386784528,438,17347,108.71326576548195,12.355298336841013,181173933,3753,93561,17.404129793510325,75.7782621171,44.78404990329101,48.04343686796857,81.91775961833892,4.7,462493.12974263745,2081.773563953949,18.51358611357232,3.8174385064228282,-3423.0,80.0446023586332,0.829628068994162,69.16696418654179
18,"Buffalo-Cheektowaga, NY Metro Area",NY,56.29757094451735,62.88391925036247,49.71122263867222,62.6465352818617,209600,2.9700164371138693,3.739528530968127,5.261306262148757,992,12215,65.22522799627752,-6.492419899010327,114212008,3971,70572,1.691827173347215,88.9086059171366,79.30132460467694,56.953092713882604,68.82586618829708,4.2,273962.26407889905,1349.2149584076053,16.921090691276238,2.772741426703341,-3423.0,76.65725249424405,0.8866091226984866,69.0187717372505
19,"Virginia Beach-Chesapeake-Norfolk, VA-NC Metro Area",VA,56.02819331000049,49.03795075866693,63.018435861334055,29.066288082544286,318000,3.948691840611923,1.5763660388315737,3.9918652332407545,946,7954,53.08720362041257,-100.0,0,0,80533,11.096651049800451,71.98699617267252,49.67550168823421,58.97247732557289,95.64422515597508,3.5,359155.1680688264,1803.2587643086988,16.597505544659167,4.912772694610826,-129.0,64.62259533471702,0.9126478953802741,71.23515417434524
20,"Philadelphia-Camden-Wilmington, PA-NJ-DE-MD Metro Area",PA,55.711570384224046,57.66776935943126,53.755371409016824,69.07258778196127,326700,3.6595611215037023,2.464079705499901,4.629434457062143,1303,135674,153.227252360352,-7.246790590887098,1061612646,30114,89273,11.8514662502169,79.28965053434214,56.7787309677889,57.51663392508437,67.9091627776606,4.1,375500.893716028,1859.335769662891,16.82952678777095,2.699591016399569,-10638.0,93.40596148418916,0.8637690136206159,64.34314359344833
21,"San Jose-Sunnyvale-Santa Clara, CA Metro Area",CA,55.47755837607076,62.01375372294661,48.94136302919492,44.62683266509974,1342700,8.528111582530931,-2.06606332580287,3.9773381354464954,2521,194040,138.37663456723504,-0.9416382174399551,6698067042,82036,157444,100.0,50.01825907549738,1.3976229166470349,0.0,93.53003362672816,5.6,1539984.6400126598,3414.006103248459,37.589872265394945,4.74406602674996,-1914.0,174.8788886614818,0.6269956138304533,70.41281379133646
22,"Milwaukee-Waukesha, WI Metro Area",WI,55.29751296263864,60.744301430884065,49.85072449439322,49.9003629467461,283800,3.7144652112454843,4.1719447879541605,5.897130685866059,855,16235,80.17612218701903,-21.592191337035473,209619230,6860,76404,8.129446468853029,93.46542429735271,55.344816523177656,35.54046476701201,79.51466973272835,3.1,364421.49095988646,1423.6957520313435,21.330721494856267,3.6256785444879114,-2235.0,88.42849515673862,0.8212505222295449,69.93002940977547
23,"Ann Arbor, MI Metro Area",MI,55.211810264799546,56.70430338300409,53.719317146595,59.24491546227753,353000,4.050208820964707,1.5242330302782192,3.1865587253139926,303,8597,95.24542202717605,1.407587948563327,137656324,3933,87156,14.133263925039042,69.1982685388868,47.42203118489067,67.20484518757475,64.44368025610153,5.1,399985.37584072584,2164.8223606094575,15.397159258836327,2.4230550447742543,-1439.0,96.9347164065474,0.9213340030148893,70.3172864470324
24,"Providence-Warwick, RI-MA Metro Area",RI,55.16021090394246,58.1437412469877,52.176680560897225,52.53924787907878,385900,4.505756252481143,2.226931433959948,5.637561149294434,494,13289,93.17595614079781,-1.7063969739407492,233805707,7546,85646,16.987680027763318,80.96049339534443,38.5600191124598,42.761078164943264,88.46569435686682,4.5,498502.5038954641,2118.6566074966854,19.607649100675225,4.339945685089345,-3450.0,90.1786432620223,1.001921627549909,68.69832129653041
25,"Greensboro-High Point, NC Metro Area",NC,55.151379173305884,55.2829342480794,55.019824098532375,67.39032947458077,207600,3.290902461835994,0.30233171802097103,2.816669892489654,312,6636,84.31061856838708,-4.516859350098512,74285589,2805,63083,1.5183064376192954,60.706767939757796,67.64609633050569,68.40621209512683,70.84311428989555,3.7,254620.81591040044,1392.616566666538,15.236355673016673,2.933712275730705,1665.0,66.02646706586826,0.995127770467524,72.58347705752573
26,"Columbia, SC Metro Area",SC,54.74403962958608,47.740154756181404,61.74792450299075,44.32451824592505,213400,3.2261965954101535,0.4386619162571525,2.3824184986391828,609,7424,64.89372695621505,-100.0,0,0,66146,2.021516571230262,60.19277362662113,69.80971969169897,85.82160062717858,75.29447225483652,4.4,248071.3832952512,1562.2078065567127,13.232948387429397,3.2889183955795613,1856.0,68.76458007732171,0.990006819591067,72.72066693841744
27,"St. Louis, MO-IL Metro Area",MO,54.29701494385943,51.98432254853536,56.6097073391835,41.21449241262931,232100,2.9670821348673697,2.0411023769688694,3.8884574547196182,1477,27618,79.62316562348568,-100.0,0,0,78225,3.643935450286309,74.46648225429328,79.41953625183585,64.99024591698111,74.93644748931023,4.1,263197.42216549534,1396.7775810092196,15.702656465851815,3.2603490042221357,-3466.0,81.4666713053159,0.8498471117943328,69.086614857098
28,"Baltimore-Columbia-Towson, MD Metro Area",MD,54.294397145262735,55.28087749224759,53.30791679827789,57.23962632881343,373300,3.8365878725590954,0.8655250152531284,2.7830590997869775,2023,44465,85.5258725382032,3.8283256858650194,1332169862,34373,97300,15.894499392677425,63.993380682723455,52.30254018765375,54.944801627037585,61.136618056049464,3.8,391726.858040778,1891.7796564024893,17.25565909658259,2.1591605789884865,-9208.0,85.81375959880896,0.8140365101940462,65.62954980593163
29,"Oklahoma City, OK Metro Area",OK,53.5173575451264,48.79539132487717,58.23932376537564,42.63777019415729,214700,3.0454332685570007,0.547382078073648,2.0709391310337777,597,9529,74.02618478789545,-100.0,0,0,70499,2.1343050494534097,59.889905318804686,76.34123958073292,71.51223646837607,65.22668836514879,3.2,239568.5364223572,1345.6695199675837,14.835770897407278,2.485536937809014,2608.0,69.30737168036204,0.920992390582458,73.14956016058463
30,"Allentown-Bethlehem-Easton, PA-NJ Metro Area",PA,53.06594216965393,52.72371472862436,53.4081696106835,37.9233396643352,277800,3.363114694559454,2.506278923161042,4.8617879546553056,303,10128,101.75124008297401,-100.0,0,0,82602,7.60888426166927,80.25773921008847,65.32977968470493,59.869997949031585,68.1291556511356,4.1,350432.5785762283,1774.4183812957308,16.457626447730835,2.7171458424991344,-360.0,71.24093473005641,0.7232246774547647,71.1267870702088
31,"Minneapolis-St. Paul-Bloomington, MN-WI Metro Area",MN,52.911223694944454,47.88656899152119,57.93587839836771,31.863103429637384,354400,3.6096964758606642,1.363224673078552,1.7010614078471153,1620,42280,92.01006419563858,-100.0,0,0,98180,14.254728440048586,63.663792237723825,58.1188299914926,48.32908803672413,83.57799698216684,3.7,375609.89703347906,1695.7962620292392,18.45789229145631,3.949920880718068,-6026.0,85.29495146187108,0.7247955626017879,68.00616915118874
32,"Indianapolis-Carmel-Greenwood, IN Metro Area",IN,52.66511102890588,49.092513729215426,56.23770832859634,40.424526764258204,244000,3.166158437682476,1.0968603562991845,2.2768206829250515,1233,25903,83.85582663473568,-100.0,0,0,77065,4.67638382786743,63.82999390123711,71.8963606580728,64.32874679986911,70.87587406010269,3.7,285178.9322859435,1504.463116100683,15.796273613821322,2.9363264152706074,86.0,82.07300826005861,0.9133111361138375,71.38428129873915
33,"Kansas City, MO-KS Metro Area",MO,52.57049419741443,51.865706596725374,53.27528179810349,32.64940251851621,265400,3.239469283630549,2.288357022687292,3.7074564118844577,1695,17958,60.33105597543062,-100.0,0,0,81927,6.5330557001561695,75.39846154304344,69.3588634960664,52.01946818034911,78.61043136904424,4.1,311790.4789503016,1462.3736227405182,17.767374567269147,3.5535228106394037,-485.0,79.63331116136757,0.8297808882811187,71.01883515507772
34,"San Francisco-Oakland-Fremont, CA Metro Area",CA,52.34958877486372,53.30708339238869,51.39209415733874,46.67675522472502,1113800,8.32560920914935,-2.8306793280371503,0.129268166759422,6588,240664,105.3674014984157,13.61299948364929,11441619774,121773,133780,80.14055179593961,33.589763295979786,2.41014630972423,13.28677968866249,100.0,5.6,1087917.108810567,3099.0917742860843,29.25365418984144,5.2603515443612014,-15432.0,162.1823009312546,0.6408920234875941,63.81017896774171
35,"Des Moines-West Des Moines, IA Metro Area",IA,51.7153149809744,57.84078746220736,45.58984249974144,50.35354714885945,252400,2.9973043261409114,1.3819208729546142,2.786078445476159,1435,6572,35.57172772722006,-12.288673878346124,142363135,4577,84209,5.405170917924692,67.11089044286435,78.21308609309838,45.141567555131395,56.130600859588284,3.7,286598.93810836255,1250.4958298804452,19.099019982055378,1.7596941783402942,-1685.0,71.98346456692913,1.006319317601075,70.0362824687926
36,"Lafayette-West Lafayette, IN Metro Area",IN,51.68530983651739,41.43761348339146,61.933006189643315,54.67962640267879,204300,3.410969196093163,-0.7407529861598945,-1.3421867247157104,90,5050,123.77407662097824,-100.0,0,0,59895,1.2319972236682284,41.647010170135324,63.848806602139284,100.0,53.9197466813677,3.7,193480.5810473496,1348.858275058275,11.953354961068255,1.5832740970117456,-863.0,65.80488782051282,0.992544278102293,70.6738016860103
37,"Cincinnati, OH-KY-IN Metro Area",OH,51.62117182065275,53.13522897865832,50.10711466264718,45.863420704879886,240200,3.021763743867153,2.4449905904788656,4.204305485232851,371,22030,126.32270101689684,-100.0,0,0,79490,4.3466944299843835,77.86820997805489,77.25435102792211,62.309889377019715,62.03247623183594,4.8,297207.96248355997,1539.393554646913,16.08901773831589,2.230647596896786,-938.0,82.22544903195708,0.8732188992806633,70.70228314653137
38,"Birmingham, AL Metro Area",AL,51.193388623798235,45.95008069233903,56.43669655525744,40.86970815977959,226200,3.248739713042354,0.37525408162710105,0.6079715792468132,287,5720,81.92937452613975,-100.0,0,0,69627,3.1320492798889465,54.357739307299966,69.04614403289528,67.18621793706963,57.97811459973988,2.8,252254.39514200247,1365.041391508205,15.399679252173446,1.907120692266006,-99.0,83.4985384865216,0.8892743656608914,71.25771468200651
39,"Madison, WI Metro Area",WI,50.47352035988372,51.5045145110623,49.44252620870515,30.843050681420216,344600,3.9688115447959738,2.482705898494359,5.0343464168837615,274,9880,104.83363700325205,-100.0,0,0,86827,13.404476834981779,80.64617212855201,49.21972541221758,42.06196379489864,62.404049576541986,3.1,427011.70967812074,1800.623714644462,19.762212865706708,2.260298127600409,-569.0,81.20692257925383,0.911864832122672,70.9303910003177
40,"Richmond, VA Metro Area",VA,50.394428439728216,49.18721249994213,51.60164437951431,35.357131067638015,325800,3.859960902790119,1.4087404581957224,3.4992025957274686,428,21185,118.23124980525148,-100.0,0,0,84405,11.773381919139338,69.46395198146676,51.74222704471979,45.76269906794547,72.58059503663708,3.5,380430.86767573626,1671.1407957227043,18.97061719003826,3.0723584594847297,1297.0,83.77921396233843,1.041273611023723,72.35071354679869
41,"Gainesville, FL Metro Area",FL,50.21963448865604,46.38976781737076,54.049501159941315,66.05309374252747,245800,4.1699182302446305,-2.797027386983476,0.9239369115217277,220,5847,92.70903763620584,0.0,0,0,58946,4.832552490022557,36.23455896282478,44.90570360321732,72.70409412640554,67.03717197947884,3.9,297027.2506335342,1685.2503283938556,14.687592976005083,2.630008549564606,-86.0,82.64090106007068,1.1242532867416732,71.25114438017158
42,"Greenville-Anderson-Greer, SC Metro Area",SC,50.16090830393881,57.83375688396965,42.48805972390798,64.10485319256806,242700,3.516575866465747,1.0267566331588078,2.1067543319338355,451,6530,70.66612500058275,10.890449627159171,99005464,3465,69016,4.563595349644283,62.885371656681315,60.723177760499844,60.273096084047374,43.21708588440736,4.4,304764.35976323974,1549.0180273713142,16.39556772839421,0.7292312085968676,5700.0,87.12428323776504,1.1865398205791773,76.46321701000011
43,"Boston-Cambridge-Newton, MA-NH Metro Area",MA,50.08526372769751,55.68325141540552,44.48727603998949,52.172840776296454,610900,5.430994630347427,1.3787328186988634,4.582454454136475,2890,103832,104.68531014422582,2.54736541077365,3236304850,60924,112484,36.50876279715426,72.61247275249501,25.13699361026202,40.44010408420645,49.37356140864409,4.7,709858.6542475243,2938.593515501363,20.130340430519787,1.2205010188731993,-15927.0,127.46672833795868,0.9374437480508262,59.9805605613364
44,"Fresno, CA Metro Area",CA,49.73354630153426,51.03102124132049,48.43607136174803,62.09302044475016,363300,5.0530620192775775,-0.06706045987005359,2.0626395671564657,467,23171,118.33611549362809,2.575087413401822,24218536,1117,71897,15.026895714037828,56.16601667239117,30.02604058587666,60.44611995646645,69.15190791016552,5.6,399477.4017776398,2033.69994863149,16.36907327645419,2.7987586591627087,-2418.0,54.271156289707754,0.6950995236270032,70.04760123889109
45,"Fayetteville-Springdale-Rogers, AR Metro Area",AR,49.44040166890869,52.27012866893002,46.61067466888737,31.67933113188006,273400,3.50607214762949,2.8517852221440103,3.8027812597297705,494,8324,75.92235273580823,-100.0,0,0,77979,7.227138643067847,79.08274386801651,61.02562253976663,43.928100942115975,67.72691792865649,3.9,359355.5484903327,1547.2159949578672,19.354954838314736,2.685048378807391,2247.0,82.35644576633516,0.9816887781763253,73.00057197449111
46,"Houston-Pasadena-The Woodlands, TX Metro Area",TX,49.400926607483505,53.60911940034175,45.192733814625264,69.83385243396108,275200,3.4204181063411965,-2.002313622534682,-0.6129804208776402,3470,157394,114.45280918400296,0.0,1205105039,35861,80458,7.383307305222974,36.29462690830935,63.56128626178462,65.92419646479303,34.123234271942394,4.1,303674.5448959297,1625.0729097305048,15.57235489136145,0.003566867246195429,20057.0,84.85029280454572,0.8473487355453223,84.23729849608713
47,"Memphis, TN-MS-AR Metro Area",TN,49.12282858264119,42.45359924691799,55.792057918364385,51.02572164449812,228100,3.523160805029115,-0.6008957902944555,0.08703287632190193,140,11421,141.16552186880375,-100.0,0,0,64743,3.2968939788304703,46.881218500071355,60.53449026739746,78.29360400618125,57.83274719977193,3.6,240716.4663852601,1429.731528394,14.030400207119886,1.89552077365649,-1914.0,65.72380605556134,0.9252120581222694,69.9791409534148
48,"Miami-Fort Lauderdale-West Palm Beach, FL Metro Area",FL,49.0240489067973,49.001322590660756,49.04677522293384,57.9080981216279,405600,5.519794232522693,-4.553479901276345,0.9713563191614094,3904,52728,68.30859628192789,5.958656623067471,1456175421,39088,73481,18.696859274683327,25.80805558473273,24.0853887065722,73.06846601395452,40.03782646940816,3.9,467083.4112146811,2658.193879467192,14.642881357106003,0.4755350534709136,12660.0,256.524909623453,1.751610734096452,88.17305642664822
49,"New York-Newark-Jersey City, NY-NJ Metro Area",NY,48.8284137121977,38.43372850861629,59.223098915779104,59.2871437102881,587400,6.034890171985124,3.083035532380397,4.863923527138558,11641,675110,125.25625026923106,-5.294794609056098,6675791836,135957,97334,34.4698941523512,83.73584936711595,18.5958012127262,52.420277821162074,88.46247708610716,4.2,699394.634660732,3293.660322796854,17.695475704742986,4.339688955733485,-100024.0,133.36266866709082,0.938526312084202,0.0
50,"Charlotte-Concord-Gastonia, NC-SC Metro Area",NC,48.29286105144741,54.44456990693833,42.141152195956494,59.44388544256406,319400,3.9824939838655378,-0.8194564966822708,1.2242669819524377,1209,49376,109.99933559890178,-7.297548403449161,647420019,19788,80201,11.218115564809995,49.0607250840615,48.912404749333895,48.988170989577846,42.218907370832106,3.7,382168.76820880984,1737.38414261287,18.33065962190637,0.6495793092178274,15721.0,93.02722880186006,0.990803207093437,83.15927770922437
51,"Dallas-Fort Worth-Arlington, TX Metro Area",TX,48.00250528599788,54.35965656783311,41.64535400416264,63.74856175134939,330300,3.7897997819975906,-3.7427594471874146,-1.476082481752361,5379,246678,114.9244256681833,-1.6333658324369282,4111416445,119219,87155,12.163803574527156,23.16617918996738,53.444939018384474,50.479128553816075,38.35931023515031,4.1,359523.2027465252,1659.921188592045,18.049210469417673,0.341594075600815,35077.0,106.3937936683853,1.0759653203994348,100.0
52,"Atlanta-Sandy Springs-Roswell, GA Metro Area",GA,47.93042867932462,43.34084814397958,52.52000921466966,38.607965971081214,335100,3.8812573837707616,-2.6286546636964667,0.2540874260080539,3795,151099,108.93440562988891,-100.0,0,0,86338,12.580253340274163,35.18937176376906,51.237569998425684,56.277246584971586,58.883877720998065,3.4,376192.30898192833,1840.5910053275256,17.0322244274191,1.979398097574293,15488.0,80.85308291523633,0.8340595787221559,81.13939678406209
53,"Stockton-Lodi, CA Metro Area",CA,47.38497337886369,45.05611002479717,49.71383673293021,62.178889572113874,494500,5.585614078684302,-4.152935018840729,-0.284568425816456,379,33307,144.78187742939852,12.067258461214347,18810673,610,88531,26.40985597778935,24.359157288633032,23.32749745736694,48.10830022800573,78.60311709127481,5.6,523017.269107694,2355.817746487763,18.50091013645718,3.5529391513950936,-2776.0,60.136673346693385,0.7294183281950747,69.78614931674491
54,"Bakersfield-Delano, CA Metro Area",CA,47.22392671734596,49.97080856763161,44.47704486706032,56.78959357863443,310600,4.590600059119125,-0.5285900617340987,2.9524648934685205,521,12362,88.38668464850726,-8.310065549133473,27595321,1248,67660,10.45462432760715,56.12271572666094,37.10379962777593,58.25689677270785,61.741857296203506,5.6,357337.8944547195,1781.9767414789428,16.7107444098919,2.2074570053304288,-3980.0,56.15095353209777,0.7510101801215232,69.05360202723962
55,"Columbus, OH Metro Area",OH,46.399598102372934,48.5717384885579,44.22745771618797,41.10097743550867,274300,3.43532004959485,0.9500948253706213,3.416179515522866,762,40437,121.29152992120189,-100.0,0,0,79847,7.30522297414541,66.44817162125388,63.11105012570791,51.266896099128445,56.9159815091666,4.8,319705.75941547076,1488.0584970812124,17.90396457546109,1.822365393582538,-2132.0,79.76836585488832,0.7518945955896917,70.10664489853053
56,"Seattle-Tacoma-Bellevue, WA Metro Area",WA,46.26010883835049,53.08905829929777,39.43115937740322,45.405579407506316,673500,5.981668650194504,-1.6256199593757057,1.826191394436405,5321,137852,91.72730270623153,4.224567844628879,4789060905,75750,112594,41.93996182543814,46.05824278086506,19.11920807200243,16.987840613924334,62.105653049372,4.5,730101.0381026445,2208.2773834094955,27.55168061418219,2.236486905625626,1843.0,113.88914877740787,0.7597369122380676,72.38844676855173
57,"Orlando-Kissimmee-Sanford, FL Metro Area",FL,46.019518940671134,48.467463815201334,43.57157406614093,61.91009449498438,338500,4.476861832273082,-4.169437442311786,-0.5470598004510774,1191,40912,102.8559683345701,2.2440305819327433,745710222,22587,75611,12.875238591011625,23.45311757720884,39.06854895420341,60.835824756404996,36.655690652527205,3.9,382156.4609124232,1952.601743071397,16.309711827158534,0.2056499195908619,14492.0,90.1327332135979,1.3117010868378651,85.76742131738648
58,"Tampa-St. Petersburg-Clearwater, FL Metro Area",FL,45.65209985579596,49.56566575812134,41.73853395347058,63.707697093503114,306100,4.29589917759003,-5.277550190956345,-1.8429639077568338,2581,42221,74.88320434369217,9.187607306489532,783969376,25046,71254,10.06420267221933,12.800613181717189,42.40899938464444,72.22635317187697,18.30714576956282,3.9,354666.2644511939,2004.2219381601951,14.746631336013824,-1.2585134849437847,22144.0,108.54725479659892,1.502211010413617,96.59870531564182
59,"Yuba City, CA Metro Area",CA,45.42434577540645,47.640262685620385,43.20842886519251,58.598871303287765,390800,5.2272544875739015,-1.7774764799745977,0.5874158730553969,208,11420,122.80275352127141,2.1391393972039374,3225669,130,74762,17.412805830296723,41.33709801101821,27.68480592738034,51.677707819183695,61.47852343716453,5.6,420778.89272263594,1966.7185185185183,17.82914402682285,2.186443687814567,-933.0,47.93544973544974,0.7365935000055199,70.80245090676488
60,"Raleigh-Cary, NC Metro Area",NC,45.23658063338195,52.937232556703385,37.53592871006052,67.56725539228991,381000,3.966023358940728,-2.5677427785340106,-0.07216483095030535,482,52168,155.1945703005628,21.161912829752506,905040873,22952,96066,16.562554225229913,34.55334011804976,49.28261081091889,35.23807942872597,34.46366714634476,3.7,431547.1310450203,1679.7329000007749,21.40951154817636,0.030732474087491884,8945.0,97.8048275862069,1.0773663148359747,78.64665020169042
61,"Durham-Chapel Hill, NC Metro Area",NC,44.88900939970084,50.24688489950319,39.53113389989848,53.7556024252344,359400,4.436106002443932,-1.1501930482488367,1.39933448763494,154,7553,117.83103389067948,-7.717606795054621,27496850,590,81017,14.688530279368383,47.608025687251924,39.7970966317291,39.8227609906743,45.18709757109602,3.7,405874.9377010208,1668.28229618196,20.27409363061178,0.8864327216625238,2041.0,107.55267273898242,0.9109229153176627,72.73718535736215
62,"Modesto, CA Metro Area",CA,44.67796676830146,49.86632872238888,39.48960481421405,66.7831284535418,426600,5.355192628764389,-1.1844681933078565,1.6231932872251553,39,9505,200.17706215826948,5.690797071296605,6781250,302,79661,20.51882699982648,48.089702079680514,26.06226694623916,48.38086522336392,50.162430028430215,5.6,458194.85762039205,2069.777228163993,18.44783307214646,1.2834505645425665,-2142.0,52.720127795527155,0.5933357228802486,70.35897908469063
63,"Salt Lake City-Murray, UT Metro Area",UT,44.49805360930637,56.370455517896026,32.625651700716716,43.23808844025793,478200,5.031300962701878,1.4654300197036134,1.538733746640153,1036,9349,55.267686085787005,14.98655589223652,925910691,23142,95045,24.9956619816068,63.78009607775917,30.329911335258043,14.736884144742355,42.063320330517826,3.4,551355.9029673894,1608.632747052509,28.562346086432537,0.6371638914230611,-52.0,79.86726569608736,0.9188595484152129,71.28830155869578
64,"Washington-Arlington-Alexandria, DC-VA-MD-WV Metro Area",DC,43.19279988336628,45.46120149115614,40.92439827557642,24.7284053641576,553000,4.463420933686318,-0.09725520244875153,2.5780217341236256,9340,181121,80.93575052609081,-100.0,0,0,123896,31.48533749783099,57.56818710229824,39.30734691367258,40.721224174886714,38.15941189454033,6.2,567339.7383089144,2356.192831352172,20.065552741118722,0.32564273794351234,-13344.0,101.01325504779687,0.8289819937508559,62.91995059654833
65,"Oxnard-Thousand Oaks-Ventura, CA Metro Area",CA,43.12846903259131,51.97166165888933,34.2852764062933,38.675781959540856,768400,7.15942866193968,-1.2451910662564067,2.4280588817307436,585,10734,78.94564975637401,-6.580354494912832,141497337,3301,107327,50.17352073572792,50.197785541090774,9.355833959172728,25.32124005631326,44.83558225345961,5.6,859803.7530404348,2941.2523969808244,24.36047747106577,0.8583827663391214,-5182.0,106.4272417707151,0.9512372176366378,67.57940506155387
66,"Sacramento-Roseville-Folsom, CA Metro Area",CA,42.86508340934405,45.21880750079494,40.51135931789317,49.63818434716811,559000,5.947694337454514,-2.3373882505407595,0.19960760373392006,1766,54732,98.72391011481851,-0.873389099661015,302494748,9908,93986,32.00589970501475,36.77509710304203,19.45822667599695,36.60348482139194,59.57582390569202,5.6,567351.9379216317,2245.1653798158836,21.058283093610306,2.0346134995583967,-11928.0,96.03551387500961,1.0569347385712515,61.745950059972834
67,"Nashville-Davidson--Murfreesboro--Franklin, TN Metro Area",TN,41.73168266916771,46.06449105599967,37.398874282335754,24.402574867575446,376800,4.567328088825319,-0.5165120473269142,0.51689833997135,1206,16160,68.04237453027878,-100.0,0,0,82499,16.198160680201283,48.71022953765443,37.497844182464505,37.0625069593163,39.479089832356465,3.6,447624.26734023733,1781.1398599573934,20.942781146476285,0.4309494069271709,12441.0,121.54428356749278,1.2784152592535802,83.40874969392044
68,"Riverside-San Bernardino-Ontario, CA Metro Area",CA,41.70857824997729,43.649944736449655,39.767211763504925,46.80696596807365,493600,5.737466727109995,-2.4318899161697263,1.3173849679129157,4873,34999,48.33780381851744,6.398215231236004,99763487,4005,86031,26.331771646711783,39.64152950462736,21.64530721751231,44.98989636763076,51.29765407467327,5.6,574942.5886989891,2504.458087104651,19.13063853544952,1.3740383204141529,-22299.0,73.65317894193105,0.9743738022666969,54.81640576764304
69,"Jacksonville, FL Metro Area",FL,41.54645113938469,41.521664211449206,41.57123806732018,34.33716763128725,308900,4.011011127991378,-3.1192680075062764,-1.4973496356439409,652,16974,91.91429299383161,-100.0,0,0,77013,10.307131702238417,26.853667058282767,48.278621320901976,54.85705148978779,37.01068224200981,3.9,345365.173427512,1666.4426857386811,17.27057963964832,0.23397727184431397,11615.0,114.19168570123344,1.5515432981510506,85.01675969431845
70,"San Diego-Chula Vista-Carlsbad, CA Metro Area",CA,41.404417517777745,50.0550641939356,32.75377084161988,41.54893509504827,791600,7.739160189666129,-2.377642301207288,3.1856975671287646,2782,44507,74.10620095145501,6.02744395279875,1045553420,24246,102285,52.18636127017179,45.70990346372429,5.641349364426247,21.100384476185614,48.77096158648712,5.6,910767.7883274832,2932.8137186776544,25.878669078299826,1.1724152108263444,-12954.0,94.86442921663293,0.9497043156701833,61.9774158579792
71,"Merced, CA Metro Area",CA,41.341086366923776,46.84332491664517,35.83884781720238,57.5876378942419,368400,5.663858311296968,-2.0611423139889906,1.0474523102799393,185,5925,100.03377237612372,7.689824992223371,645244,50,65044,15.469373590144023,41.04351136873516,22.449460344147205,54.00935060107245,40.38185635231261,5.6,412344.0865572055,1973.0071884384383,17.416057789579927,0.5029876916952508,-821.0,46.83355006501951,0.8780876444906022,70.77687041641276
72,"Phoenix-Mesa-Chandler, AZ Metro Area",AZ,40.88822200298632,50.44190830931971,31.334535696652928,53.3911672915273,401400,4.73891125461908,-3.017387966333521,-0.7847375221788244,2943,59984,82.74648493014524,7.7249874991728085,1393633663,38010,84703,18.332465729654693,29.656950212290575,34.68349658853471,36.40128623314464,25.408328894168452,4.2,441999.2314755253,1744.8614541383413,21.109566723632135,-0.6918586070629845,14451.0,105.7234286500493,1.1749902110700285,84.22552944405606
73,"Portland-Vancouver-Hillsboro, OR-WA Metro Area",OR,40.70240349120223,48.77748155208239,32.62732543032207,38.51171970449257,526500,5.567128038657968,-1.4423552202390615,0.44471375218984033,2390,27370,62.845356510442386,-14.741733504603694,533935572,13875,94573,29.18618774943606,42.91565731838386,23.53854757441269,24.096103247202656,47.237060701278814,5.2,536763.5651409285,1804.916208971437,24.782478473373406,1.050014139971376,1175.0,96.28249201016143,0.9201767547769831,72.14608601880346
74,"Las Vegas-Henderson-North Las Vegas, NV Metro Area",NV,40.53513264844072,50.60598602510119,30.46427927178026,43.9971064397108,400800,5.427584806012594,-2.2168140579839646,1.2131721850979993,5691,13428,18.731115854687232,7.0093823998719,363255871,9631,73845,18.28040950893632,40.6158139807955,25.17806031527472,39.05690120888985,34.72611175384687,5.3,426817.4337854017,1738.8209299673626,20.455309036787597,0.05167483177705509,9044.0,109.41462608152543,1.353388437697115,80.62436392420412
75,"Denver-Aurora-Centennial, CO Metro Area",CO,38.76773644381284,48.11603455671833,29.419438330907337,39.43522413362935,570300,5.572655585847038,-3.130354393046679,-0.6020201066849862,2517,25481,58.879055896683184,-5.6092283917624215,2194636608,50810,102339,32.98629186187749,29.538537999702726,23.475294317730803,24.42912997016421,22.062561814292874,4.1,559323.4180925377,1889.6322025745355,24.666326482762347,-0.9588416157809562,6094.0,100.79523390594373,1.0258943480537306,76.07460639665419
76,"San Antonio-New Braunfels, TX Metro Area",TX,38.5305628386393,40.42938010859242,36.63174556868618,36.372211182354604,258700,3.4819710082506696,-2.5818966667872942,-2.529779807634258,1171,18437,73.55082085436311,-100.0,0,0,74297,5.951761235467639,26.915200842900195,61.726489228473994,59.16604334360537,18.767443839777577,4.1,274977.01213175553,1383.1448614639376,16.56713743398242,-1.2217829652276355,8730.0,77.89022304098954,0.9316563841279986,77.50418088834249
77,"Los Angeles-Long Beach-Anaheim, CA Metro Area",CA,37.85284633150724,44.536748797831976,31.1689438651825,34.509849192814976,825300,8.824378508420208,-1.3984305992873232,2.9259257514154147,28797,161052,41.09894781560097,-3.2770519687978505,3080705640,63279,93525,55.11018566718723,50.80550948151347,0.0,18.88978071838645,52.36473107247167,5.6,932886.2424506668,2905.9865194707454,26.751851628816496,1.4591881292934226,-41560.0,109.42171332927572,0.9043636906303957,42.76794796894092
78,"Austin-Round Rock-San Marcos, TX Metro Area",TX,34.71640157408673,44.395917130802864,25.036886017370602,55.92292559273742,434800,4.453184211065364,-5.581592921145434,-5.412617253256302,1220,64692,121.25757564175159,2.136779750724438,3045317197,59240,97638,21.23026201631095,0.0,39.490184834188014,32.406013416948014,0.0,4.1,422294.2294924664,1586.8535916968667,22.1767061404877,-2.7193733541185763,15919.0,159.27234362226298,1.2124000648294138,85.98853632748954
79,"Louisville/Jefferson County, KY-IN Metro Area",KY,,52.6796580578812,,,236400,3.2953705897932726,,,1030,8587,52.827267322874015,-6.250695004240303,196214022,7142,71737,4.017005032101336,50.23058457549184,67.49982804389991,,34.07853514645155,4.7,,,,,300.0,73.59838324453426,0.8589117992872471,71.5203800291499`;

        function parseCSV(csvString) {
            const lines = csvString.split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;

                const values = [];
                let current = '';
                let inQuotes = false;

                for (let char of lines[i]) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());

                const obj = {};
                headers.forEach((header, index) => {
                    let value = values[index] || '';
                    value = value.replace(/"/g, '');

                    if (header === 'Metropolitan Area' || header === 'State') {
                        obj[header] = value;
                    } else {
                        const num = parseFloat(value);
                        obj[header] = isNaN(num) ? value : num;
                    }
                });

                data.push(obj);
            }

            return data;
        }

        const rawData = parseCSV(csvData);

        // Transform data
        const markets = rawData.map(d => {
            const metroName = d['Metropolitan Area'].replace(' Metro Area', '');
            const shortName = metroName.split(',')[0].split('-')[0];

            return {
                rank: d['Rank'],
                name: shortName,
                fullName: metroName,
                state: d['State'],
                investmentScore: d['Investment Score (v2)'] || 0,
                appreciationScore: d['Appreciation Score'] || 0,
                cashFlowScore: d['Cash Flow Score'] || 0,
                migrationScore: d['Migration Score (0-100)'] || 0,
                netMigration: d['Net Migration (Households)'] || 0,
                homeValue: d['Zillow Home Value'] || d['Median Home Value'] || 0,
                priceToIncome: d['Price-to-Income Ratio'] || 0,
                agiRatio: d['AGI Ratio (In/Out)'] || 0,
                avgAgiInflow: d['Avg AGI Inflow ($K)'] || 0,
                priceChange1Y: d['1-Year Price Change (%)'] || 0,
                rentGrowth: d['1-Year Rent Change (%)'] || 0,
                coordinates: metroCoordinates[metroName] || null,
                // Component scores for breakdown
                supplyConstraintScore: d['Supply Constraint (0-100)'] || 0,
                priceMomentumScore: d['Price Momentum (0-100)'] || 0,
                affordabilityGapScore: d['Affordability Gap (0-100)'] || 0,
                priceToRentScore: d['Price-to-Rent (0-100)'] || 0,
                rentGrowthScore: d['Rent Growth (0-100)'] || 0,
                // Raw values for display
                priceChange3Y: d['3-Year Price CAGR (%)'] || 0,
                priceToRentRatio: d['Price-to-Rent Ratio'] || 0,
                unemploymentRate: d['Unemployment Rate (%)'] || 0,
                medianIncome: d['Median Income'] || 0
            };
        }).filter(d => d.investmentScore > 0);

        // State variables
        let selectedMarket = markets[0];
        let colorMetric = 'investmentScore';
        let sortMetric = 'investmentScore';
        let alpha = 0.7;

        // Map zoom state (set by initMap)
        let mapZoom = null;
        let mapSvg = null;
        let mapProjection = null;
        let mapWidth = 0;
        let mapHeight = 0;

        // Color scale
        function getColorScale(metric) {
            const values = markets.map(d => d[metric]).filter(v => !isNaN(v) && v !== null);
            const extent = d3.extent(values);

            return d3.scaleSequential()
                .domain(extent)
                .interpolator(d3.interpolateRgbBasis(['#0abde3', '#feca57', '#ff4d4d']));
        }

        // Format helpers
        function formatCurrency(value) {
            if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;
            if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;
            return `$${value.toFixed(0)}`;
        }

        function formatNumber(value) {
            if (Math.abs(value) >= 1000) {
                return value.toLocaleString('en-US', { maximumFractionDigits: 0 });
            }
            return value.toFixed(1);
        }

        // Percentile calculation helper
        function getPercentile(value, allValues) {
            const sorted = [...allValues].filter(v => !isNaN(v) && v !== null).sort((a, b) => a - b);
            const index = sorted.findIndex(v => v >= value);
            if (index === -1) return 100;
            return Math.round((index / sorted.length) * 100);
        }

        // Pre-compute percentile arrays for all metrics
        const percentileData = {
            netMigration: markets.map(m => m.netMigration),
            agiRatio: markets.map(m => m.agiRatio),
            priceChange1Y: markets.map(m => m.priceChange1Y),
            priceChange3Y: markets.map(m => m.priceChange3Y),
            supplyConstraintScore: markets.map(m => m.supplyConstraintScore),
            priceToIncome: markets.map(m => m.priceToIncome),
            priceToRentRatio: markets.map(m => m.priceToRentRatio),
            rentGrowth: markets.map(m => m.rentGrowth),
            medianIncome: markets.map(m => m.medianIncome),
            unemploymentRate: markets.map(m => m.unemploymentRate),
            migrationScore: markets.map(m => m.migrationScore),
            priceMomentumScore: markets.map(m => m.priceMomentumScore),
            affordabilityGapScore: markets.map(m => m.affordabilityGapScore),
            priceToRentScore: markets.map(m => m.priceToRentScore),
            rentGrowthScore: markets.map(m => m.rentGrowthScore)
        };

        // Interpretation generators for each component
        function getMigrationInterpretation(m) {
            const pctMigration = getPercentile(m.netMigration, percentileData.netMigration);
            const pctAgi = getPercentile(m.agiRatio, percentileData.agiRatio);

            let meaning = '';
            if (m.netMigration > 5000) {
                meaning = `${m.name} gained ${formatNumber(m.netMigration)} households in net migration, indicating strong population inflows. `;
                meaning += m.agiRatio > 1 ? `Incoming residents earn more than those leaving (AGI ratio: ${m.agiRatio.toFixed(2)}), signaling wealth accumulation.` : `However, incoming residents earn less than those leaving (AGI ratio: ${m.agiRatio.toFixed(2)}).`;
            } else if (m.netMigration > 0) {
                meaning = `${m.name} has modest positive migration of ${formatNumber(m.netMigration)} households. `;
                meaning += m.agiRatio > 1 ? `Incoming earners are higher-income than departing ones.` : `Migration income quality is neutral to negative.`;
            } else if (m.netMigration > -5000) {
                meaning = `${m.name} has slight outmigration of ${formatNumber(Math.abs(m.netMigration))} households, but this is modest. `;
                meaning += m.agiRatio > 0.9 ? `Income quality of migrants remains relatively balanced.` : `Higher earners appear to be leaving the area.`;
            } else {
                meaning = `${m.name} is experiencing significant outmigration of ${formatNumber(Math.abs(m.netMigration))} households. `;
                meaning += m.agiRatio > 0.9 ? `Despite outflows, income quality remains stable.` : `Both population and income quality are declining.`;
            }

            const comparison = `Ranks in the <span class="highlight">${pctMigration > 50 ? 'top' : 'bottom'} ${pctMigration > 50 ? 100 - pctMigration : pctMigration}%</span> for net migration among all 79 metros analyzed.`;

            return { meaning, comparison };
        }

        function getMomentumInterpretation(m) {
            const pct1Y = getPercentile(m.priceChange1Y, percentileData.priceChange1Y);

            let meaning = '';
            if (m.priceChange1Y > 3) {
                meaning = `Home prices rose ${m.priceChange1Y.toFixed(1)}% over the past year, showing strong upward momentum. `;
                meaning += m.priceChange3Y > 3 ? `The 3-year trend (${m.priceChange3Y.toFixed(1)}% CAGR) confirms sustained appreciation.` : `However, the 3-year trend is weaker, suggesting recent acceleration.`;
            } else if (m.priceChange1Y > 0) {
                meaning = `Prices grew modestly at ${m.priceChange1Y.toFixed(1)}% year-over-year. `;
                meaning += `The 3-year CAGR of ${m.priceChange3Y.toFixed(1)}% provides context for the medium-term trend.`;
            } else if (m.priceChange1Y > -3) {
                meaning = `Prices declined slightly by ${Math.abs(m.priceChange1Y).toFixed(1)}% over the past year, indicating a cooling market. `;
                meaning += m.priceChange3Y > 0 ? `The positive 3-year CAGR suggests this may be a temporary correction.` : `The negative 3-year trend suggests structural challenges.`;
            } else {
                meaning = `Prices dropped ${Math.abs(m.priceChange1Y).toFixed(1)}% year-over-year, a significant correction. `;
                meaning += `This follows a 3-year CAGR of ${m.priceChange3Y.toFixed(1)}%, ${m.priceChange3Y > 0 ? 'suggesting a pullback from prior gains' : 'indicating persistent weakness'}.`;
            }

            const comparison = `1-year price change ranks <span class="highlight">${pct1Y > 50 ? 'above' : 'below'} average</span> (${pct1Y}th percentile) compared to other metros.`;

            return { meaning, comparison };
        }

        function getSupplyInterpretation(m) {
            const pct = getPercentile(m.supplyConstraintScore, percentileData.supplyConstraintScore);

            let meaning = '';
            if (m.supplyConstraintScore > 70) {
                meaning = `${m.name} has highly constrained housing supply due to limited building permits, geographic barriers, or regulatory restrictions. `;
                meaning += `Constrained supply typically supports price appreciation when demand increases.`;
            } else if (m.supplyConstraintScore > 40) {
                meaning = `Housing supply in ${m.name} faces moderate constraints. `;
                meaning += `New construction can partially meet demand growth, creating balanced market dynamics.`;
            } else if (m.supplyConstraintScore > 15) {
                meaning = `${m.name} has relatively loose supply constraints with active new construction. `;
                meaning += `Ample building can dampen price appreciation as supply keeps pace with demand.`;
            } else {
                meaning = `${m.name} has very few supply constraints, with abundant land and permissive zoning. `;
                meaning += `This typically limits appreciation potential as builders can easily add inventory.`;
            }

            const comparison = `Supply constraint score is in the <span class="highlight">${pct > 50 ? 'top' : 'bottom'} ${pct > 50 ? 100 - pct : pct}%</span> of metros, meaning ${pct > 50 ? 'more constrained than most' : 'less constrained than most'}.`;

            return { meaning, comparison };
        }

        function getAffordabilityInterpretation(m) {
            const pct = getPercentile(m.priceToIncome, percentileData.priceToIncome);

            let meaning = '';
            if (m.priceToIncome < 3.5) {
                meaning = `With homes priced at ${m.priceToIncome.toFixed(1)}x median income, ${m.name} is highly affordable. `;
                meaning += `Affordable markets have room for price growth as they attract cost-conscious buyers and investors.`;
            } else if (m.priceToIncome < 5) {
                meaning = `At ${m.priceToIncome.toFixed(1)}x income, ${m.name} has moderate affordability. `;
                meaning += `Homes are accessible to middle-income buyers, supporting stable demand.`;
            } else if (m.priceToIncome < 7) {
                meaning = `${m.name}'s price-to-income ratio of ${m.priceToIncome.toFixed(1)}x indicates stretched affordability. `;
                meaning += `Many local workers may struggle to afford homes, potentially limiting demand growth.`;
            } else {
                meaning = `At ${m.priceToIncome.toFixed(1)}x income, ${m.name} is severely unaffordable for local workers. `;
                meaning += `High prices relative to incomes may cap appreciation potential and increase correction risk.`;
            }

            // Note: lower price-to-income = higher score, so invert the percentile interpretation
            const comparison = `Affordability ranks <span class="highlight">${pct < 50 ? 'better' : 'worse'} than ${pct < 50 ? 100 - pct : pct}%</span> of metros (lower ratio = more affordable).`;

            return { meaning, comparison };
        }

        function getTechWageInterpretation(m) {
            return {
                meaning: `Tech wage growth measures the salary trajectory in the technology sector, which drives high-income employment and housing demand in many metros.`,
                comparison: `This metric is weighted at only 10% of the appreciation score as it's less universally predictive than migration patterns.`
            };
        }

        function getPriceToRentInterpretation(m) {
            const pct = getPercentile(m.priceToRentRatio, percentileData.priceToRentRatio);

            let meaning = '';
            if (m.priceToRentRatio < 15) {
                meaning = `With a price-to-rent ratio of ${m.priceToRentRatio.toFixed(1)}x, ${m.name} offers excellent cash flow potential. `;
                meaning += `Investors can achieve strong yields relative to purchase price, making rental properties attractive.`;
            } else if (m.priceToRentRatio < 20) {
                meaning = `The ${m.priceToRentRatio.toFixed(1)}x price-to-rent ratio indicates decent cash flow potential. `;
                meaning += `Rental yields are reasonable, though not exceptional by national standards.`;
            } else if (m.priceToRentRatio < 25) {
                meaning = `At ${m.priceToRentRatio.toFixed(1)}x, the price-to-rent ratio suggests modest cash flow returns. `;
                meaning += `High purchase prices relative to rents make achieving positive cash flow challenging.`;
            } else {
                meaning = `The ${m.priceToRentRatio.toFixed(1)}x ratio indicates poor cash flow economics. `;
                meaning += `Investors must rely heavily on appreciation rather than rental income for returns.`;
            }

            // Lower ratio = higher score, so invert
            const comparison = `Cash flow potential ranks in the <span class="highlight">${pct < 50 ? 'top' : 'bottom'} ${pct < 50 ? 100 - pct : pct}%</span> of metros (lower ratio = better yields).`;

            return { meaning, comparison };
        }

        function getRentGrowthInterpretation(m) {
            const pct = getPercentile(m.rentGrowth, percentileData.rentGrowth);

            let meaning = '';
            if (m.rentGrowth > 4) {
                meaning = `Rents grew ${m.rentGrowth.toFixed(1)}% over the past year, significantly outpacing inflation. `;
                meaning += `Strong rent growth improves cash flow over time and indicates robust tenant demand.`;
            } else if (m.rentGrowth > 2) {
                meaning = `Rent growth of ${m.rentGrowth.toFixed(1)}% is healthy and roughly matches or exceeds inflation. `;
                meaning += `Steady rent increases help maintain and improve investment returns over time.`;
            } else if (m.rentGrowth > 0) {
                meaning = `Rents increased modestly at ${m.rentGrowth.toFixed(1)}%, below the inflation rate. `;
                meaning += `Weak rent growth may indicate softening demand or increased rental supply.`;
            } else {
                meaning = `Rents declined ${Math.abs(m.rentGrowth).toFixed(1)}% year-over-year, eroding cash flow. `;
                meaning += `Negative rent growth signals oversupply or weakening demand in the rental market.`;
            }

            const comparison = `Rent growth ranks in the <span class="highlight">${pct}th percentile</span> among all metros analyzed.`;

            return { meaning, comparison };
        }

        function getIncomeStabilityInterpretation(m) {
            const pct = getPercentile(m.medianIncome, percentileData.medianIncome);

            let meaning = '';
            if (m.medianIncome > 100000) {
                meaning = `${m.name}'s median income of ${formatCurrency(m.medianIncome)} indicates a wealthy population. `;
                meaning += `High incomes support premium rents and provide a stable tenant base for landlords.`;
            } else if (m.medianIncome > 80000) {
                meaning = `With median income of ${formatCurrency(m.medianIncome)}, ${m.name} has above-average earning power. `;
                meaning += `Solid incomes support reliable rent payments and moderate rent growth potential.`;
            } else if (m.medianIncome > 60000) {
                meaning = `Median income of ${formatCurrency(m.medianIncome)} is around the national average. `;
                meaning += `This supports a stable rental market, though tenants may be more price-sensitive.`;
            } else {
                meaning = `At ${formatCurrency(m.medianIncome)}, median income is below the national average. `;
                meaning += `Lower incomes may limit rent levels and increase tenant turnover risk.`;
            }

            const comparison = `Income level ranks in the <span class="highlight">${pct}th percentile</span> compared to other metros in this analysis.`;

            return { meaning, comparison };
        }

        function getEmploymentInterpretation(m) {
            const pct = getPercentile(m.unemploymentRate, percentileData.unemploymentRate);

            let meaning = '';
            if (m.unemploymentRate < 3.5) {
                meaning = `Unemployment of ${m.unemploymentRate.toFixed(1)}% indicates a tight labor market. `;
                meaning += `Low unemployment supports rent stability and reduces tenant default risk.`;
            } else if (m.unemploymentRate < 4.5) {
                meaning = `At ${m.unemploymentRate.toFixed(1)}%, unemployment is near the healthy full-employment range. `;
                meaning += `The job market is balanced, supporting steady rental demand.`;
            } else if (m.unemploymentRate < 5.5) {
                meaning = `Unemployment of ${m.unemploymentRate.toFixed(1)}% is slightly elevated. `;
                meaning += `Some slack in the job market may create modest headwinds for rent growth.`;
            } else {
                meaning = `At ${m.unemploymentRate.toFixed(1)}%, unemployment is concerning. `;
                meaning += `Weak employment increases vacancy risk and may pressure rents downward.`;
            }

            // Lower unemployment = better, so invert
            const comparison = `Job market strength ranks <span class="highlight">${pct < 50 ? 'better' : 'worse'} than ${pct < 50 ? 100 - pct : pct}%</span> of metros (lower unemployment = stronger).`;

            return { meaning, comparison };
        }

        // Show tooltip at a specific position (for programmatic display)
        function showTooltipAt(market, x, y) {
            const tooltip = document.getElementById('tooltip');
            const metricLabels = {
                investmentScore: 'Investment Score',
                appreciationScore: 'Appreciation Score',
                cashFlowScore: 'Cash Flow Score',
                migrationScore: 'Migration Score',
                netMigration: 'Net Migration'
            };

            tooltip.innerHTML = `
                <div class="tooltip-title">${market.fullName}</div>
                <div class="tooltip-row"><span>${metricLabels[colorMetric]}</span><span>${formatNumber(market[colorMetric])}</span></div>
                <div class="tooltip-row"><span>Home Value</span><span>${formatCurrency(market.homeValue)}</span></div>
                <div class="tooltip-row"><span>Net Migration</span><span>${formatNumber(market.netMigration)}</span></div>
            `;

            tooltip.style.left = (x + 15) + 'px';
            tooltip.style.top = (y + 15) + 'px';
            tooltip.classList.add('active');
        }

        // Zoom to a specific market on the map
        function zoomToMarket(market) {
            if (!mapZoom || !mapSvg || !mapProjection || !market.coordinates) return;

            const coords = mapProjection(market.coordinates);
            if (!coords) return;

            // Zoom to 4x scale centered on the market
            const scale = 4;
            const transform = d3.zoomIdentity
                .translate(mapWidth / 2, mapHeight / 2)
                .scale(scale)
                .translate(-coords[0], -coords[1]);

            mapSvg.transition()
                .duration(750)
                .call(mapZoom.transform, transform)
                .on('end', () => {
                    // Show tooltip at center of map after zoom completes
                    showTooltipAt(market, mapWidth / 2, mapHeight / 2);
                });
        }

        // Initialize map
        function initMap() {
            const container = document.querySelector('.map-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Store dimensions for zoom calculations
            mapWidth = width;
            mapHeight = height;

            const svg = d3.select('#us-map')
                .attr('width', width)
                .attr('height', height);

            // Store SVG reference
            mapSvg = svg;

            svg.selectAll('*').remove();

            // Create a container group for all map elements (for zoom/pan)
            const mapGroup = svg.append('g').attr('class', 'map-group');

            // Projection
            const projection = d3.geoAlbersUsa()
                .scale(width * 1.1)
                .translate([width / 2, height / 2]);

            // Store projection reference
            mapProjection = projection;

            const colorScale = getColorScale(colorMetric);

            // Track current zoom scale for circle sizing
            let currentZoomScale = 1;

            // Helper to get circle radius at current zoom
            const getCircleRadius = (d) => {
                const score = d[colorMetric] || 0;
                return Math.max(5, Math.min(20, score / 5)) / currentZoomScale;
            };

            const getHoverRadius = (d) => {
                const score = d[colorMetric] || 0;
                return Math.max(7, Math.min(25, score / 5 + 3)) / currentZoomScale;
            };

            // Set up zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([1, 8])
                .on('start', (event) => {
                    // Hide tooltip when user starts panning/zooming
                    if (event.sourceEvent) {
                        hideTooltip();
                    }
                })
                .on('zoom', (event) => {
                    currentZoomScale = event.transform.k;
                    mapGroup.attr('transform', event.transform);

                    // Update circle sizes to maintain constant screen size
                    mapGroup.selectAll('circle')
                        .attr('r', getCircleRadius)
                        .attr('stroke-width', 1 / currentZoomScale);

                    // Keep state borders consistent
                    mapGroup.selectAll('.states-layer path')
                        .attr('stroke-width', 0.5 / currentZoomScale);
                });

            // Store zoom reference for external access
            mapZoom = zoom;

            svg.call(zoom);

            // Double-click to reset zoom
            svg.on('dblclick.zoom', () => {
                svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
            });

            // Draw base map
            d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json').then(us => {
                // Draw states
                mapGroup.append('g')
                    .attr('class', 'states-layer')
                    .selectAll('path')
                    .data(topojson.feature(us, us.objects.states).features)
                    .join('path')
                    .attr('d', d3.geoPath().projection(projection))
                    .attr('fill', '#1a1a26')
                    .attr('stroke', '#2a2a3a')
                    .attr('stroke-width', 0.5);

                // Draw metro circles
                const circles = mapGroup.append('g')
                    .attr('class', 'circles-layer')
                    .selectAll('circle')
                    .data(markets.filter(d => d.coordinates))
                    .join('circle')
                    .attr('cx', d => {
                        const coords = projection(d.coordinates);
                        return coords ? coords[0] : 0;
                    })
                    .attr('cy', d => {
                        const coords = projection(d.coordinates);
                        return coords ? coords[1] : 0;
                    })
                    .attr('r', d => {
                        const score = d[colorMetric] || 0;
                        return Math.max(5, Math.min(20, score / 5));
                    })
                    .attr('fill', d => colorScale(d[colorMetric]))
                    .attr('fill-opacity', 0.8)
                    .attr('stroke', '#fff')
                    .attr('stroke-width', 1)
                    .attr('stroke-opacity', 0.3)
                    .style('cursor', 'pointer')
                    .on('mouseover', function(event, d) {
                        d3.select(this)
                            .attr('stroke-width', 2 / currentZoomScale)
                            .attr('stroke-opacity', 1)
                            .attr('r', getHoverRadius(d));

                        showTooltip(event, d);
                    })
                    .on('mouseout', function(event, d) {
                        d3.select(this)
                            .attr('stroke-width', 1 / currentZoomScale)
                            .attr('stroke-opacity', 0.3)
                            .attr('r', getCircleRadius(d));

                        hideTooltip();
                    })
                    .on('click', (event, d) => {
                        selectMarket(d);
                        zoomToMarket(d);
                    });
            });
        }

        // Tooltip
        function showTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            const metricLabels = {
                investmentScore: 'Investment Score',
                appreciationScore: 'Appreciation Score',
                cashFlowScore: 'Cash Flow Score',
                migrationScore: 'Migration Score',
                netMigration: 'Net Migration'
            };

            tooltip.innerHTML = `
                <div class="tooltip-title">${d.fullName}</div>
                <div class="tooltip-row"><span>${metricLabels[colorMetric]}</span><span>${formatNumber(d[colorMetric])}</span></div>
                <div class="tooltip-row"><span>Home Value</span><span>${formatCurrency(d.homeValue)}</span></div>
                <div class="tooltip-row"><span>Net Migration</span><span>${formatNumber(d.netMigration)}</span></div>
            `;

            tooltip.style.left = (event.offsetX + 15) + 'px';
            tooltip.style.top = (event.offsetY + 15) + 'px';
            tooltip.classList.add('active');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('active');
        }

        // Update map colors
        function updateMapColors() {
            const colorScale = getColorScale(colorMetric);

            d3.select('#us-map')
                .selectAll('circle')
                .transition()
                .duration(500)
                .attr('fill', d => colorScale(d[colorMetric]))
                .attr('r', d => {
                    const score = d[colorMetric] || 0;
                    return Math.max(5, Math.min(20, score / 5));
                });
        }

        // Select market
        function selectMarket(market) {
            selectedMarket = market;
            updateMarketCard();
            updateRankingsList();
            updateScoreBreakdown();
        }

        // Generate 5-sentence market summary
        function generateMarketSummary(m) {
            const totalMarkets = markets.length;
            const appreciationRank = [...markets].sort((a, b) => b.appreciationScore - a.appreciationScore).findIndex(x => x.rank === m.rank) + 1;
            const cashFlowRank = [...markets].sort((a, b) => b.cashFlowScore - a.cashFlowScore).findIndex(x => x.rank === m.rank) + 1;
            const migrationRank = [...markets].sort((a, b) => b.netMigration - a.netMigration).findIndex(x => x.rank === m.rank) + 1;
            const affordabilityRank = [...markets].sort((a, b) => a.priceToIncome - b.priceToIncome).findIndex(x => x.rank === m.rank) + 1;

            // Determine character (appreciation-leaning vs cash-flow-leaning)
            const appreciationLean = m.appreciationScore > m.cashFlowScore;
            const scoreDiff = Math.abs(m.appreciationScore - m.cashFlowScore);
            const isBalanced = scoreDiff < 8;

            // Sentence 1: Overall Position & Character
            let sentence1 = '';
            if (m.rank <= 5) {
                sentence1 = `<span class="sentence-position">${m.name}</span> ranks <strong>#${m.rank}</strong> overall among ${totalMarkets} metros`;
            } else if (m.rank <= 15) {
                sentence1 = `<span class="sentence-position">${m.name}</span> is a <strong>top-15 market</strong> (#${m.rank} of ${totalMarkets})`;
            } else if (m.rank <= 25) {
                sentence1 = `<span class="sentence-position">${m.name}</span> lands in the <strong>top quartile</strong> at #${m.rank} of ${totalMarkets} metros`;
            } else if (m.rank <= 40) {
                sentence1 = `<span class="sentence-position">${m.name}</span> sits in the <strong>upper-middle tier</strong> at #${m.rank} of ${totalMarkets}`;
            } else {
                sentence1 = `<span class="sentence-position">${m.name}</span> ranks #${m.rank} of ${totalMarkets} metros analyzed`;
            }

            if (isBalanced) {
                sentence1 += ', with a <strong>balanced profile</strong> across appreciation and cash flow metrics.';
            } else if (appreciationLean) {
                sentence1 += ', <strong>leaning toward appreciation</strong> over cash flow.';
            } else {
                sentence1 += ', <strong>stronger on cash flow</strong> than appreciation potential.';
            }

            // Sentence 2: Key Strength
            let sentence2 = '';
            const strengths = [];
            if (appreciationRank <= 15) strengths.push({ type: 'appreciation', rank: appreciationRank });
            if (cashFlowRank <= 15) strengths.push({ type: 'cashFlow', rank: cashFlowRank });
            if (affordabilityRank <= 15) strengths.push({ type: 'affordability', rank: affordabilityRank });
            if (migrationRank <= 15) strengths.push({ type: 'migration', rank: migrationRank });

            if (strengths.length === 0) {
                // Find best relative strength
                const rankings = [
                    { type: 'appreciation', rank: appreciationRank },
                    { type: 'cashFlow', rank: cashFlowRank },
                    { type: 'affordability', rank: affordabilityRank }
                ];
                const best = rankings.reduce((a, b) => a.rank < b.rank ? a : b);
                strengths.push(best);
            }

            const primaryStrength = strengths.sort((a, b) => a.rank - b.rank)[0];

            if (primaryStrength.type === 'appreciation') {
                sentence2 = `<span class="sentence-strength">Its standout strength is appreciation potential</span> (#${appreciationRank} of ${totalMarkets})`;
                if (m.priceChange1Y > 8) {
                    sentence2 += `, driven by <strong>${m.priceChange1Y.toFixed(1)}% price momentum</strong> over the past year.`;
                } else if (m.migrationScore > 60) {
                    sentence2 += ', supported by strong migration inflows.';
                } else {
                    sentence2 += ', suggesting above-average growth trajectory.';
                }
            } else if (primaryStrength.type === 'cashFlow') {
                sentence2 = `<span class="sentence-strength">Its standout strength is cash flow potential</span> (#${cashFlowRank} of ${totalMarkets})`;
                if (m.priceToRentRatio < 15) {
                    sentence2 += `, with an attractive <strong>${m.priceToRentRatio.toFixed(1)}x price-to-rent ratio</strong>.`;
                } else {
                    sentence2 += ', offering solid rental income fundamentals.';
                }
            } else if (primaryStrength.type === 'affordability') {
                sentence2 = `<span class="sentence-strength">Its standout strength is affordability</span> (#${affordabilityRank} by price-to-income)`;
                sentence2 += `, with homes at just <strong>${m.priceToIncome.toFixed(1)}x</strong> local median income.`;
            } else {
                sentence2 = `<span class="sentence-strength">Its standout strength is migration momentum</span> (#${migrationRank})`;
                sentence2 += `, attracting ${formatNumber(Math.abs(m.netMigration))} net households recently.`;
            }

            // Sentence 3: Migration & Demographic Story
            let sentence3 = '';
            if (m.netMigration > 10000) {
                sentence3 = `<span class="sentence-migration">Migration is a major tailwind:</span> ${m.name} gained <strong>${formatNumber(m.netMigration)} households</strong>`;
                if (m.agiRatio > 1.1) {
                    sentence3 += `, and importantly, in-movers earn <strong>${((m.agiRatio - 1) * 100).toFixed(0)}% more</strong> than those leavingâ€”signaling wealth accumulation.`;
                } else if (m.agiRatio > 0.95) {
                    sentence3 += ', with income-neutral migration patterns.';
                } else {
                    sentence3 += `, though out-movers have higher incomes (AGI ratio: ${m.agiRatio.toFixed(2)}).`;
                }
            } else if (m.netMigration > 0) {
                sentence3 = `<span class="sentence-migration">Migration is modestly positive:</span> ${m.name} gained <strong>${formatNumber(m.netMigration)} households</strong>`;
                if (m.agiRatio > 1.05) {
                    sentence3 += `, with wealthier newcomers (AGI ratio: ${m.agiRatio.toFixed(2)}) adding purchasing power.`;
                } else {
                    sentence3 += ', maintaining population stability.';
                }
            } else if (m.netMigration > -5000) {
                sentence3 = `<span class="sentence-migration">Migration is slightly negative:</span> ${m.name} lost <strong>${formatNumber(Math.abs(m.netMigration))} households</strong>`;
                if (m.agiRatio > 1.0) {
                    sentence3 += `, but those arriving have higher incomesâ€”a potential silver lining.`;
                } else {
                    sentence3 += ', a modest concern for demand-driven appreciation.';
                }
            } else {
                sentence3 = `<span class="sentence-migration">Migration is a headwind:</span> ${m.name} lost <strong>${formatNumber(Math.abs(m.netMigration))} households</strong>`;
                if (m.agiRatio < 0.9) {
                    sentence3 += `, and departing residents had higher incomesâ€”watch for demand softness.`;
                } else {
                    sentence3 += ', which may limit near-term appreciation potential.';
                }
            }

            // Sentence 4: Key Risk or Limitation
            let sentence4 = '';
            const risks = [];
            if (m.priceToIncome > 5) risks.push({ type: 'affordability', severity: m.priceToIncome });
            if (m.netMigration < -5000) risks.push({ type: 'outmigration', severity: Math.abs(m.netMigration) });
            if (m.agiRatio < 0.85) risks.push({ type: 'wealth_drain', severity: 1 - m.agiRatio });
            if (m.cashFlowScore < 40) risks.push({ type: 'low_cashflow', severity: 50 - m.cashFlowScore });
            if (m.appreciationScore < 40) risks.push({ type: 'low_appreciation', severity: 50 - m.appreciationScore });
            if (m.priceChange1Y < 0) risks.push({ type: 'price_decline', severity: Math.abs(m.priceChange1Y) });

            if (risks.length === 0) {
                sentence4 = `<span class="sentence-risk">Risk profile is relatively low</span>â€”no major red flags across affordability, migration, or cash flow metrics.`;
            } else {
                const primaryRisk = risks[0];
                if (primaryRisk.type === 'affordability') {
                    sentence4 = `<span class="sentence-risk">Key concern: affordability.</span> At <strong>${m.priceToIncome.toFixed(1)}x income</strong>, prices may face resistance without continued wage growth or migration pressure.`;
                } else if (primaryRisk.type === 'outmigration') {
                    sentence4 = `<span class="sentence-risk">Key concern: population loss.</span> Outmigration of ${formatNumber(Math.abs(m.netMigration))} households could soften demand and limit price growth.`;
                } else if (primaryRisk.type === 'wealth_drain') {
                    sentence4 = `<span class="sentence-risk">Key concern: income quality.</span> Out-movers earn more than in-movers (AGI ratio: ${m.agiRatio.toFixed(2)})â€”potential drag on high-end market demand.`;
                } else if (primaryRisk.type === 'low_cashflow') {
                    sentence4 = `<span class="sentence-risk">Key concern: weak cash flow fundamentals.</span> Rental yields may not cover costs, making this a pure appreciation play.`;
                } else if (primaryRisk.type === 'low_appreciation') {
                    sentence4 = `<span class="sentence-risk">Key concern: limited appreciation potential.</span> Focus on rental income rather than value growth.`;
                } else if (primaryRisk.type === 'price_decline') {
                    sentence4 = `<span class="sentence-risk">Key concern: recent price softness.</span> Prices dropped <strong>${Math.abs(m.priceChange1Y).toFixed(1)}%</strong> last yearâ€”timing the entry point matters.`;
                }
            }

            // Sentence 5: Investor Fit
            let sentence5 = '';
            if (appreciationLean && m.appreciationScore > 60) {
                sentence5 = `<span class="sentence-fit">Best suited for growth-focused investors with a 5+ year horizon seeking capital appreciation over immediate income.</span>`;
            } else if (!appreciationLean && m.cashFlowScore > 60) {
                sentence5 = `<span class="sentence-fit">Best suited for income-focused investors prioritizing rental yields and steady cash flow over speculative gains.</span>`;
            } else if (isBalanced && m.investmentScore > 55) {
                sentence5 = `<span class="sentence-fit">Well-suited for balanced investors seeking both moderate appreciation and reasonable cash flow.</span>`;
            } else if (m.priceToIncome < 3.5 && m.cashFlowScore > 50) {
                sentence5 = `<span class="sentence-fit">Attractive for value investorsâ€”affordable entry point with solid rental fundamentals.</span>`;
            } else if (m.netMigration > 5000 && m.appreciationScore > 50) {
                sentence5 = `<span class="sentence-fit">Appeals to investors betting on demographic trends and population-driven demand.</span>`;
            } else {
                sentence5 = `<span class="sentence-fit">Consider carefully based on your investment timeline and risk toleranceâ€”this market has trade-offs to weigh.</span>`;
            }

            return `
                <p>${sentence1}</p>
                <p>${sentence2}</p>
                <p>${sentence3}</p>
                <p>${sentence4}</p>
                <p>${sentence5}</p>
            `;
        }

        // Update market card
        function updateMarketCard() {
            const m = selectedMarket;

            document.querySelector('.market-rank').textContent = `Rank #${m.rank}`;
            document.querySelector('.market-name').textContent = m.name;
            document.querySelector('.market-state').textContent = m.state;

            document.getElementById('card-investment').textContent = m.investmentScore.toFixed(1);
            document.getElementById('card-appreciation').textContent = m.appreciationScore.toFixed(1);
            document.getElementById('card-cashflow').textContent = m.cashFlowScore.toFixed(1);
            document.getElementById('card-migration').textContent = m.migrationScore.toFixed(1);

            document.querySelector('.score-bar-fill.investment').style.width = `${m.investmentScore}%`;
            document.querySelector('.score-bar-fill.appreciation').style.width = `${m.appreciationScore}%`;
            document.querySelector('.score-bar-fill.cashflow').style.width = `${m.cashFlowScore}%`;
            document.querySelector('.score-bar-fill.migration').style.width = `${m.migrationScore}%`;

            document.getElementById('card-home-value').textContent = formatCurrency(m.homeValue);
            document.getElementById('card-pti').textContent = `${m.priceToIncome.toFixed(2)}x`;
            document.getElementById('card-net-migration').textContent = formatNumber(m.netMigration);
            document.getElementById('card-agi-ratio').textContent = m.agiRatio.toFixed(2);

            // Update market summary
            document.getElementById('market-summary-text').innerHTML = generateMarketSummary(m);
        }

        // Update rankings list
        function updateRankingsList() {
            const sorted = [...markets].sort((a, b) => b[sortMetric] - a[sortMetric]);
            const list = document.getElementById('rankings-list');

            list.innerHTML = sorted.slice(0, 25).map((m, i) => `
                <div class="ranking-item ${m.rank === selectedMarket.rank ? 'active' : ''}" data-rank="${m.rank}">
                    <span class="ranking-position">${i + 1}</span>
                    <div class="ranking-info">
                        <div class="ranking-name">${m.name}</div>
                        <div class="ranking-state">${m.state}</div>
                    </div>
                    <span class="ranking-score">${m[sortMetric].toFixed(1)}</span>
                </div>
            `).join('');

            // Add click handlers
            list.querySelectorAll('.ranking-item').forEach(item => {
                item.addEventListener('click', () => {
                    const rank = parseInt(item.dataset.rank);
                    const market = markets.find(m => m.rank === rank);
                    if (market) {
                        selectMarket(market);
                        zoomToMarket(market);
                    }
                });
            });
        }

        // Update score breakdown panel
        function updateScoreBreakdown() {
            const m = selectedMarket;

            // Update market name in header
            document.getElementById('breakdown-market-name').textContent = m.name;

            // Get interpretations for this market
            const migrationInterp = getMigrationInterpretation(m);
            const momentumInterp = getMomentumInterpretation(m);
            const supplyInterp = getSupplyInterpretation(m);
            const affordabilityInterp = getAffordabilityInterpretation(m);
            const techWageInterp = getTechWageInterpretation(m);
            const priceToRentInterp = getPriceToRentInterpretation(m);
            const rentGrowthInterp = getRentGrowthInterpretation(m);
            const incomeInterp = getIncomeStabilityInterpretation(m);
            const employmentInterp = getEmploymentInterpretation(m);

            // Appreciation Score Components
            // Formula: 0.30 Ã— Migration + 0.25 Ã— Momentum + 0.20 Ã— Supply + 0.15 Ã— Affordability + 0.10 Ã— TechWage
            const appreciationComponents = [
                {
                    name: 'Migration Quality',
                    score: m.migrationScore,
                    rawValue: `${formatNumber(m.netMigration)} HH`,
                    rawTooltip: `Net migration: ${formatNumber(m.netMigration)} households, AGI ratio: ${m.agiRatio.toFixed(2)}`,
                    weight: 0.30,
                    description: 'IRS migration data: net households + income quality',
                    interpretation: migrationInterp
                },
                {
                    name: 'Price Momentum',
                    score: m.priceMomentumScore,
                    rawValue: `${m.priceChange1Y >= 0 ? '+' : ''}${m.priceChange1Y.toFixed(1)}%`,
                    rawTooltip: `1Y: ${m.priceChange1Y.toFixed(1)}%, 3Y CAGR: ${m.priceChange3Y.toFixed(1)}%`,
                    weight: 0.25,
                    description: '60% Ã— 1-year change + 40% Ã— 3-year CAGR',
                    interpretation: momentumInterp
                },
                {
                    name: 'Supply Constraint',
                    score: m.supplyConstraintScore,
                    rawValue: `Score: ${m.supplyConstraintScore.toFixed(0)}`,
                    rawTooltip: 'Inverse of building permits per capita (lower supply = higher score)',
                    weight: 0.20,
                    description: 'Markets where building is constrained appreciate more',
                    interpretation: supplyInterp
                },
                {
                    name: 'Affordability Gap',
                    score: m.affordabilityGapScore,
                    rawValue: `${m.priceToIncome.toFixed(1)}x`,
                    rawTooltip: `Price-to-income ratio: ${m.priceToIncome.toFixed(2)}x (lower = more affordable = higher score)`,
                    weight: 0.15,
                    description: 'Inverse of price-to-income (affordable markets can grow)',
                    interpretation: affordabilityInterp
                },
                {
                    name: 'Tech Wage Growth',
                    score: 50, // Placeholder - not in CSV
                    rawValue: 'N/A',
                    rawTooltip: 'Tech sector wage CAGR',
                    weight: 0.10,
                    description: 'Employment sector strength',
                    interpretation: techWageInterp
                }
            ];

            // Cash Flow Score Components
            // Formula: 0.40 Ã— P/R + 0.30 Ã— RentGrowth + 0.20 Ã— IncomeStability + 0.10 Ã— Unemployment
            const cashFlowComponents = [
                {
                    name: 'Price-to-Rent',
                    score: m.priceToRentScore,
                    rawValue: `${m.priceToRentRatio.toFixed(1)}x`,
                    rawTooltip: `Price-to-rent ratio: ${m.priceToRentRatio.toFixed(1)}x (lower ratio = better cash flow = higher score)`,
                    weight: 0.40,
                    description: 'Inverse of P/R ratio (lower = better yields)',
                    interpretation: priceToRentInterp
                },
                {
                    name: 'Rent Growth',
                    score: m.rentGrowthScore,
                    rawValue: `${m.rentGrowth >= 0 ? '+' : ''}${m.rentGrowth.toFixed(1)}%`,
                    rawTooltip: `1-year rent change: ${m.rentGrowth.toFixed(1)}%`,
                    weight: 0.30,
                    description: 'Higher rent growth = improving yields',
                    interpretation: rentGrowthInterp
                },
                {
                    name: 'Income Stability',
                    score: Math.min(100, (m.medianIncome / 1500)), // Normalized estimate
                    rawValue: formatCurrency(m.medianIncome),
                    rawTooltip: `Median income: ${formatCurrency(m.medianIncome)} (higher = more stable tenants)`,
                    weight: 0.20,
                    description: 'Higher local income = stable tenant pool',
                    interpretation: incomeInterp
                },
                {
                    name: 'Employment',
                    score: Math.max(0, 100 - (m.unemploymentRate * 15)), // Inverse
                    rawValue: `${m.unemploymentRate.toFixed(1)}%`,
                    rawTooltip: `Unemployment rate: ${m.unemploymentRate.toFixed(1)}% (lower = better = higher score)`,
                    weight: 0.10,
                    description: 'Inverse of unemployment rate',
                    interpretation: employmentInterp
                }
            ];

            // Render appreciation components with interpretations
            const appreciationContainer = document.getElementById('appreciation-components');
            appreciationContainer.innerHTML = appreciationComponents.map((c, i) => `
                <div class="component-wrapper">
                    <div class="component-row" title="${c.description}">
                        <div class="component-name">
                            ${c.name}
                        </div>
                        <div class="component-bar-container">
                            <div class="component-bar appreciation" style="width: ${c.score}%"></div>
                        </div>
                        <div class="component-raw" title="${c.rawTooltip}">${c.rawValue}</div>
                        <div class="component-weight">Ã—${c.weight.toFixed(2)}</div>
                        <div class="component-contribution">${(c.score * c.weight).toFixed(1)}</div>
                    </div>
                    <div class="interpretation-toggle" data-target="appr-interp-${i}">
                        <span class="toggle-icon">â–¶</span>
                        <span>Show interpretation</span>
                    </div>
                    <div class="component-interpretation appreciation" id="appr-interp-${i}">
                        <div class="interpretation-meaning">${c.interpretation.meaning}</div>
                        <div class="interpretation-comparison">${c.interpretation.comparison}</div>
                    </div>
                </div>
            `).join('');

            // Render cash flow components with interpretations
            const cashFlowContainer = document.getElementById('cashflow-components');
            cashFlowContainer.innerHTML = cashFlowComponents.map((c, i) => `
                <div class="component-wrapper">
                    <div class="component-row" title="${c.description}">
                        <div class="component-name">
                            ${c.name}
                        </div>
                        <div class="component-bar-container">
                            <div class="component-bar cashflow" style="width: ${c.score}%"></div>
                        </div>
                        <div class="component-raw" title="${c.rawTooltip}">${c.rawValue}</div>
                        <div class="component-weight">Ã—${c.weight.toFixed(2)}</div>
                        <div class="component-contribution">${(c.score * c.weight).toFixed(1)}</div>
                    </div>
                    <div class="interpretation-toggle" data-target="cf-interp-${i}">
                        <span class="toggle-icon">â–¶</span>
                        <span>Show interpretation</span>
                    </div>
                    <div class="component-interpretation cashflow" id="cf-interp-${i}">
                        <div class="interpretation-meaning">${c.interpretation.meaning}</div>
                        <div class="interpretation-comparison">${c.interpretation.comparison}</div>
                    </div>
                </div>
            `).join('');

            // Add toggle event listeners
            document.querySelectorAll('.interpretation-toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const targetId = toggle.dataset.target;
                    const interpretation = document.getElementById(targetId);
                    const isExpanded = toggle.classList.contains('expanded');

                    if (isExpanded) {
                        toggle.classList.remove('expanded');
                        toggle.querySelector('span:last-child').textContent = 'Show interpretation';
                        interpretation.classList.remove('visible');
                    } else {
                        toggle.classList.add('expanded');
                        toggle.querySelector('span:last-child').textContent = 'Hide interpretation';
                        interpretation.classList.add('visible');
                    }
                });
            });

            // Update totals
            document.getElementById('appreciation-total').textContent = m.appreciationScore.toFixed(1);
            document.getElementById('cashflow-total').textContent = m.cashFlowScore.toFixed(1);
        }

        // Update alpha display and strategy highlighting
        function updateAlphaDisplay() {
            document.getElementById('formula-alpha').textContent = alpha.toFixed(2);
            document.getElementById('formula-one-minus').textContent = (1 - alpha).toFixed(2);

            // Highlight active strategy
            const growthCard = document.getElementById('growth-strategy');
            const incomeCard = document.getElementById('income-strategy');

            if (alpha >= 0.5) {
                growthCard.classList.add('active');
                incomeCard.classList.remove('active');
            } else {
                growthCard.classList.remove('active');
                incomeCard.classList.add('active');
            }
        }

        // Scatter chart
        function initScatterChart() {
            const container = document.getElementById('scatter-chart');
            const width = container.clientWidth;
            const height = container.clientHeight;
            const margin = { top: 30, right: 30, bottom: 50, left: 60 };

            const svg = d3.select('#scatter-chart')
                .html('')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Scales
            const xScale = d3.scaleLinear()
                .domain([0, 80])
                .range([0, innerWidth]);

            const yScale = d3.scaleLinear()
                .domain([0, 80])
                .range([innerHeight, 0]);

            const colorScale = d3.scaleSequential()
                .domain([30, 65])
                .interpolator(d3.interpolateRgbBasis(['#0abde3', '#feca57', '#ff4d4d']));

            // Grid
            g.append('g')
                .attr('class', 'grid')
                .selectAll('line')
                .data(xScale.ticks(8))
                .join('line')
                .attr('x1', d => xScale(d))
                .attr('x2', d => xScale(d))
                .attr('y1', 0)
                .attr('y2', innerHeight)
                .attr('stroke', '#2a2a3a')
                .attr('stroke-dasharray', '2,2');

            g.append('g')
                .attr('class', 'grid')
                .selectAll('line')
                .data(yScale.ticks(8))
                .join('line')
                .attr('x1', 0)
                .attr('x2', innerWidth)
                .attr('y1', d => yScale(d))
                .attr('y2', d => yScale(d))
                .attr('stroke', '#2a2a3a')
                .attr('stroke-dasharray', '2,2');

            // Diagonal reference line
            g.append('line')
                .attr('x1', xScale(0))
                .attr('y1', yScale(0))
                .attr('x2', xScale(80))
                .attr('y2', yScale(80))
                .attr('stroke', '#3a3a4a')
                .attr('stroke-width', 1)
                .attr('stroke-dasharray', '5,5');

            // Quadrant labels
            g.append('text')
                .attr('x', innerWidth * 0.75)
                .attr('y', innerHeight * 0.15)
                .attr('text-anchor', 'middle')
                .attr('fill', '#5a5a70')
                .attr('font-size', '11px')
                .text('High Appreciation');

            g.append('text')
                .attr('x', innerWidth * 0.25)
                .attr('y', innerHeight * 0.85)
                .attr('text-anchor', 'middle')
                .attr('fill', '#5a5a70')
                .attr('font-size', '11px')
                .text('High Cash Flow');

            // Axes
            g.append('g')
                .attr('transform', `translate(0,${innerHeight})`)
                .call(d3.axisBottom(xScale).ticks(8))
                .attr('color', '#5a5a70')
                .selectAll('text')
                .attr('fill', '#8888a0');

            g.append('g')
                .call(d3.axisLeft(yScale).ticks(8))
                .attr('color', '#5a5a70')
                .selectAll('text')
                .attr('fill', '#8888a0');

            // Axis labels
            g.append('text')
                .attr('x', innerWidth / 2)
                .attr('y', innerHeight + 40)
                .attr('text-anchor', 'middle')
                .attr('fill', '#8888a0')
                .attr('font-size', '12px')
                .text('Cash Flow Score');

            g.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('x', -innerHeight / 2)
                .attr('y', -45)
                .attr('text-anchor', 'middle')
                .attr('fill', '#8888a0')
                .attr('font-size', '12px')
                .text('Appreciation Score');

            // Points
            g.selectAll('circle')
                .data(markets.filter(d => d.cashFlowScore > 0 && d.appreciationScore > 0))
                .join('circle')
                .attr('cx', d => xScale(d.cashFlowScore))
                .attr('cy', d => yScale(d.appreciationScore))
                .attr('r', 6)
                .attr('fill', d => colorScale(d.investmentScore))
                .attr('fill-opacity', 0.7)
                .attr('stroke', '#fff')
                .attr('stroke-width', 1)
                .attr('stroke-opacity', 0.3)
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this)
                        .attr('r', 10)
                        .attr('stroke-opacity', 1)
                        .attr('fill-opacity', 1);

                    // Show tooltip
                    const chartTooltip = d3.select('#scatter-chart')
                        .append('div')
                        .attr('class', 'chart-tooltip')
                        .style('position', 'absolute')
                        .style('background', 'var(--bg-card)')
                        .style('border', '1px solid var(--border)')
                        .style('border-radius', '0.5rem')
                        .style('padding', '0.75rem')
                        .style('font-size', '0.8rem')
                        .style('pointer-events', 'none')
                        .style('left', (event.offsetX + 15) + 'px')
                        .style('top', (event.offsetY - 10) + 'px')
                        .html(`
                            <strong>${d.name}</strong><br>
                            <span style="color: var(--text-muted)">Appreciation:</span> ${d.appreciationScore.toFixed(1)}<br>
                            <span style="color: var(--text-muted)">Cash Flow:</span> ${d.cashFlowScore.toFixed(1)}
                        `);
                })
                .on('mouseout', function(event, d) {
                    d3.select(this)
                        .attr('r', 6)
                        .attr('stroke-opacity', 0.3)
                        .attr('fill-opacity', 0.7);

                    d3.selectAll('.chart-tooltip').remove();
                })
                .on('click', (event, d) => {
                    selectMarket(d);
                    zoomToMarket(d);
                });
        }

        // Update stats
        function updateStats() {
            const validScores = markets.map(d => d.investmentScore).filter(v => v > 0);
            const avgScore = validScores.reduce((a, b) => a + b, 0) / validScores.length;

            document.getElementById('total-markets').textContent = markets.length;
            document.getElementById('avg-score').textContent = avgScore.toFixed(1);
        }

        // Event listeners
        document.getElementById('color-metric').addEventListener('change', (e) => {
            colorMetric = e.target.value;
            updateMapColors();
        });

        document.getElementById('sort-metric').addEventListener('change', (e) => {
            sortMetric = e.target.value;
            updateRankingsList();
        });

        document.getElementById('alpha-slider').addEventListener('input', (e) => {
            alpha = e.target.value / 100;
            document.getElementById('alpha-value').textContent = `Î± = ${alpha.toFixed(2)}`;

            // Recalculate investment scores
            markets.forEach(m => {
                if (m.appreciationScore > 0 && m.cashFlowScore > 0) {
                    m.investmentScore = alpha * m.appreciationScore + (1 - alpha) * m.cashFlowScore;
                }
            });

            // Re-sort and update
            markets.sort((a, b) => b.investmentScore - a.investmentScore);
            markets.forEach((m, i) => m.rank = i + 1);

            updateMapColors();
            updateRankingsList();
            updateMarketCard();
            updateStats();
            updateAlphaDisplay();
        });

        // Breakdown tab switching
        document.querySelectorAll('.breakdown-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active from all tabs and content
                document.querySelectorAll('.breakdown-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.breakdown-content').forEach(c => c.classList.remove('active'));

                // Add active to clicked tab and corresponding content
                tab.classList.add('active');
                const tabType = tab.dataset.tab;
                document.getElementById(`${tabType}-breakdown`).classList.add('active');
            });
        });

        // Initialize
        window.addEventListener('load', () => {
            initMap();
            updateMarketCard();
            updateRankingsList();
            initScatterChart();
            updateStats();
            updateScoreBreakdown();
            updateAlphaDisplay();
        });

        // Handle resize
        window.addEventListener('resize', () => {
            initMap();
            initScatterChart();
        });
    </script>
</body>
</html>
